







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Techniques | miros-xml</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
    <link rel="next" title="How it Works" href="how_it_works.html">
      
      
    <link rel="prev" title="Getting Your Head in the Project" href="quickstart.html">
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros-xml
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros-xml" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros-xml" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <h3 class="sidebar-heading">About</h3>
<ul>
  <li>XML for <a "https://github.com/aleph2c/miros">miros</a> 
</ul>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting Your Head in the Project</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Techniques</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#finding-a-function-method-s-decorators">Finding a Function/Method’s Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-functions-from-templates">Creating Functions from Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#adding-and-removing-behavior-from-functions">Adding and Removing Behavior from Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="how_it_works.html">How it Works</a></li>
</ul>

        
        <h3 class="sidebar-heading">Useful Links</h3>
  <ul>
    <li><a href="https://aleph2c.github.io/miros-rabbitmq/html/index.html">miros on github</a></li>
    <li><a href="https://github.com/aleph2c/sequence">sequence on
        github</a></li>
    <li><a
          href="https://aleph2c.github.io/miros-rabbitmq/html/index.html">miros-rabbitmq
          plugin</a></li>
    <li><a href="http://www.umlet.com">UMLet Download</a></li>
    <li><a
          href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism
          explained</a></li>
  </ul>
<h3 class="sidebar-heading">Statechart Videos</h3>
  <ul>
    <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li> 
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
    <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <div class="section" id="techniques">
<h1>Techniques<a class="headerlink" href="#techniques" title="Permalink to this headline">#</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#finding-a-function-method-s-decorators" id="id1">Finding a Function/Method’s Decorators</a></p></li>
<li><p><a class="reference internal" href="#creating-functions-from-templates" id="id2">Creating Functions from Templates</a></p></li>
<li><p><a class="reference internal" href="#adding-and-removing-behavior-from-functions" id="id3">Adding and Removing Behavior from Functions</a></p></li>
</ul>
</div>
<p>This section will focus on Python techniques that aren’t specific to the design.</p>
<div class="section" id="finding-a-function-method-s-decorators">
<span id="recipes-finding-the-decorators-for-a-function-method"></span><h2>Finding a Function/Method’s Decorators<a class="headerlink" href="#finding-a-function-method-s-decorators" title="Permalink to this headline">#</a></h2>
<p><strong>Goal</strong>: Find a way to see how a function or method has been decorated.</p>
<p>To reflect upon how a function has been decorated, you can use this technique
defined by Shane Holloway on <a class="reference external" href="https://stackoverflow.com/a/9580006">stackoverflow</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">find_decorators</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;find a method/function&#39;s decorators</span>

<span class="sd">    **Note**:</span>
<span class="sd">       This function will not work for function&#39;s built from templates</span>

<span class="sd">       Solution provided by Shane Holloway on `stackoverflow</span>
<span class="sd">       &lt;https://stackoverflow.com/a/9580006&gt;`_</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``target`` (callable): the function/method</span>


<span class="sd">    **Returns**:</span>
<span class="sd">       (dict): key/value pair, key is the function/method the value is array</span>
<span class="sd">      |        of decorators</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        find_decorators(p_p22_s22)  \</span>
<span class="sd">             # =&gt; {&#39;p_p22_s22&#39;: [&quot;Name(id=&#39;orthogonal_state&#39;, ctx=Load())&quot;]</span>

<span class="sd">        find_decorators(p)  # =&gt; {&#39;p&#39;: [&quot;Name(id=&#39;state&#39;, ctx=Load())&quot;]</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">ast</span><span class="o">,</span> <span class="nn">inspect</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">def</span> <span class="nf">visit_FunctionDef</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
        <span class="n">res</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">decorator_list</span><span class="p">]</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">()</span>
    <span class="n">V</span><span class="o">.</span><span class="n">visit_FunctionDef</span> <span class="o">=</span> <span class="n">visit_FunctionDef</span>
    <span class="n">V</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsource</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">PyCF_ONLY_AST</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-functions-from-templates">
<span id="recipes-creating-functions-from-templates"></span><h2>Creating Functions from Templates<a class="headerlink" href="#creating-functions-from-templates" title="Permalink to this headline">#</a></h2>
<p>The miros-xml package <a class="reference internal" href="how_it_works.html#how-it-works-hidden-states-and-what-they-are-for"><span class="std std-ref">adds four hidden functions</span></a> (grey in the diagram) for
each orthogonal state:</p>
<a class="reference external image-reference" href="_static/hidden_states_1.pdf"><img alt="_images/hidden_states_1.svg" class="noscale-center" src="_images/hidden_states_1.svg" /></a>
<p><strong>Goal</strong>: We want the <code class="docutils literal notranslate"><span class="pre">add</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Regions</span></code> object to create the grayed
out functions for us, using a predetermined naming convention.</p>
<p>We will use the module_namespace to attach and get functions based on a string,
using the Python <code class="docutils literal notranslate"><span class="pre">setattr/getattr</span></code> builtins.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">module_namespace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>

<span class="c1"># these are the same</span>
<span class="n">module_namespace</span><span class="o">.</span><span class="n">p_r1_under_hidden_region</span><span class="p">()</span>
<span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="s1">&#39;p_r1_under_hidden_region&#39;</span><span class="p">)()</span>
</pre></div>
</div>
<p>Before we make something that writes functions, we will type one out by hand,
pass a full regression test, then identify the parts of the function we want to
change:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@othogonal_state</span>
<span class="hll"><span class="k">def</span> <span class="nf">p_r1_under_hidden_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span>  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">__super__</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">bottom</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_r1_region</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>Things that need to change in the above function:</p>
<ul class="simple">
<li><p>it needs a unique name (line 1)</p></li>
<li><p>it will reference the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> function, line 12.</p></li>
</ul>
<p>Now we write a template, knowing that we will rename it later.  We use the
<code class="docutils literal notranslate"><span class="pre">*</span></code>, character to separate the non-mandatorily-named arguments from the ones
that require a name; <code class="docutils literal notranslate"><span class="pre">region_state_name</span></code>.  We also add the <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> as a
place holder for named arguments this function will not use.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">template_under_hidden_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">region_state_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;some docstring&#39;&#39;&#39;</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">__super__</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">bottom</span>

<span class="hll">  <span class="n">region_state_function</span> <span class="o">=</span> \
</span><span class="hll">    <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">region_state_name</span><span class="p">)</span>
</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">region_state_function</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>Notice on lines 7-8, we use <code class="docutils literal notranslate"><span class="pre">getattr(module_namespace,</span> <span class="pre">region_state_name)</span></code> to
get the region function.  This function is used on line 16.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">region_state_name</span></code> was set to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code>, our function would behave
the same as the one we wrote out by hand.  Notice, that the template does not
have an <code class="docutils literal notranslate"><span class="pre">orthogonal</span></code> decorator, but our handwritten function does. This
decorator will be added later.</p>
<p>Now we want to create a new function based on some naming conventions:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>

<span class="c1"># functions at the top of the file</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">under_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_under_hidden_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">over_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_over_hidden_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">final_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_final&quot;</span>

<span class="c1"># ..</span>

<span class="c1"># in the Regions class:</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
  <span class="c1"># ...</span>
  <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;p_r1&quot;</span>  <span class="c1"># force the region_name for our example</span>
  <span class="n">under_s</span> <span class="o">=</span> <span class="n">under_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">region_s</span> <span class="o">=</span> <span class="n">region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">over_s</span> <span class="o">=</span> <span class="n">over_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">final_s</span> <span class="o">=</span> <span class="n">final_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>

  <span class="c1"># The &#39;template_under_hidden_region&#39; is defined in documentation above,</span>
  <span class="c1"># the other templates would be defined in similar manner</span>
<span class="hll">  <span class="k">for</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="p">[</span>
</span><span class="hll">    <span class="p">(</span><span class="n">under_s</span><span class="p">,</span> <span class="n">template_under_hidden_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">region_s</span><span class="p">,</span> <span class="n">template_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">over_s</span><span class="p">,</span> <span class="n">template_over_hidden_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">final_s</span><span class="p">,</span> <span class="n">template_final</span><span class="p">)</span>
</span><span class="hll">  <span class="p">]:</span>
</span>
    <span class="c1"># The &#39;template&#39; and &#39;region_state_name&#39; are used in the</span>
    <span class="c1"># &#39;template_under_hidden_region&#39;, but the other named arguments are</span>
    <span class="c1"># placed into its kwargs argument and ignored by the function.  These</span>
    <span class="c1"># extra named arguments are needed by one or more of the other template</span>
    <span class="c1"># functions.</span>
<span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span class="hll">      <span class="n">template</span><span class="p">,</span>
</span><span class="hll">      <span class="n">this_function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
</span><span class="hll">      <span class="n">under_region_state_name</span><span class="o">=</span><span class="n">under_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">region_state_name</span><span class="o">=</span><span class="n">region_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">over_region_state_name</span><span class="o">=</span><span class="n">over_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">final_state_name</span><span class="o">=</span><span class="n">final_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">initial_state_name</span><span class="o">=</span><span class="n">initial_state</span>
</span><span class="hll">    <span class="p">)</span>
</span>
<span class="hll">    <span class="c1"># give the fn the meta data defined by its template</span>
</span><span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># over-write the function name</span>
</span><span class="hll">    <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">function_name</span>
</span><span class="hll">    <span class="c1"># wrap the function with an instrumentation decorator</span>
</span><span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">orthogonal_state</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># over-write the instrumented function with its name</span>
</span><span class="hll">    <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">function_name</span>
</span><span class="hll">    <span class="c1"># place the new function in this module&#39;s namespace</span>
</span><span class="hll">    <span class="nb">setattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
</span>
  <span class="c1"># Here we get the functions from the name space using our function names as</span>
  <span class="c1"># strings.</span>
<span class="hll">  <span class="n">region_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">region_s</span><span class="p">)</span>
</span><span class="hll">  <span class="n">over_hidden_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">over_s</span><span class="p">)</span>
</span><span class="hll">  <span class="n">under_hidden_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">under_s</span><span class="p">)</span>
</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">p_r1_under_hidden_region</span><span class="p">))</span>    <span class="c1"># can call what was created</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">under_hidden_state_function</span><span class="p">))</span> <span class="c1"># can call indirectly too</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">region_function_name</span><span class="p">))</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">over_hidden_state_function</span><span class="p">))</span>

  <span class="c1"># ... construct the regions</span>
</pre></div>
</td></tr></table></div>
<p>The above code listing shows how all of our hidden functions would be made from
a set of templates, an initial_state target and some function names built by a
convention using the region name.</p>
<p>Lines 35-40 show how we specify a template-naming partnership.</p>
<p>Lines 47-55 shows how a new function is build from the template.</p>
<p>Lines 57-66 name our new function, wrap it with an instrumentation decorator,
name this wrapped function, then attach it to the modules namespace.</p>
<p>Lines 70-72 show how to get a function using its name.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you have done work like this, never use the eval(function_name_as_string)
to get access to the function.  This will destroy the function’s <code class="docutils literal notranslate"><span class="pre">__name__</span></code> and
<code class="docutils literal notranslate"><span class="pre">__doc__</span></code> values and cause your tests to fail.</p>
</div>
</div>
<div class="section" id="adding-and-removing-behavior-from-functions">
<span id="techniques-adding-and-removing-behavior-from-functions"></span><h2>Adding and Removing Behavior from Functions<a class="headerlink" href="#adding-and-removing-behavior-from-functions" title="Permalink to this headline">#</a></h2>
<p><strong>Goal</strong>: To be able to compose state functions from a set of templates which can:</p>
<ul class="simple">
<li><p>impose a behavior: when a function receives X event, call handler Y with the event</p></li>
<li><p>suggest a behavior: if the function hasn’t had a behavior imposed already, impose the
behavior</p></li>
<li><p>remove the behavior associated with a signal number</p></li>
<li><p>describe its specification</p></li>
<li><p>have the capability to do all of the above while the hsm is running</p></li>
</ul>
<a class="reference external image-reference" href="_static/small_chart.pdf"><img alt="_images/small_chart.svg" class="noscale-center" src="_images/small_chart.svg" /></a>
<p>I think it will be easier to start with the interface, then describe the
technique after we see how it is used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">template_trans</span><span class="p">(</span><span class="n">hsm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;prints out the state and signal name, then transitions&#39;&#39;&#39;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="k">assert</span> <span class="n">trans</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">hsm</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">trans</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>


<span class="k">def</span> <span class="nf">template_handled</span><span class="p">(</span><span class="n">hsm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;prints out the state and signal name&#39;&#39;&#39;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state_name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">status</span>

 <span class="c1"># define our hsm</span>
 <span class="n">hsm</span> <span class="o">=</span> <span class="n">HsmWithQueues</span><span class="p">()</span>
 <span class="n">a1</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">__template_state</span><span class="p">,</span> <span class="n">this_function_name</span><span class="o">=</span><span class="s2">&quot;a1&quot;</span><span class="p">,</span> <span class="n">super_state</span><span class="o">=</span><span class="n">hsm</span><span class="o">.</span><span class="n">top</span><span class="p">)()</span>
 <span class="n">b1</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">__template_state</span><span class="p">,</span> <span class="n">this_function_name</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="n">super_state</span><span class="o">=</span><span class="n">a1</span><span class="p">)()</span>
 <span class="n">c1</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">__template_state</span><span class="p">,</span> <span class="n">this_function_name</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="n">super_state</span><span class="o">=</span><span class="n">hsm</span><span class="o">.</span><span class="n">top</span><span class="p">)()</span>

 <span class="c1"># create some behaviors</span>
 <span class="n">a1_entry_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_handled</span><span class="p">)</span>
 <span class="n">a1_init_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span>
 <span class="n">a1_e1_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>

 <span class="c1"># link the behaviors with signals names</span>
 <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">a1_entry_hh</span><span class="p">)</span>
 <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">a1_init_hh</span><span class="p">)</span>
 <span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">a1_e1_hh</span><span class="p">)</span>

 <span class="n">b1_entry_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_handled</span><span class="p">)</span>
 <span class="n">b1_init_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_handled</span><span class="p">)</span>

 <span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">b1_entry_hh</span><span class="p">)</span>
 <span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">b1_init_hh</span><span class="p">)</span>

 <span class="n">c1_entry_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_handled</span><span class="p">)</span>
 <span class="n">c1_init_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_handled</span><span class="p">)</span>
 <span class="n">c1_e2_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">)</span>

 <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c1_entry_hh</span><span class="p">)</span>
 <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c1_init_hh</span><span class="p">)</span>
 <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c1_e2_hh</span><span class="p">)</span>

 <span class="c1"># Run our hsm</span>
 <span class="n">hsm</span><span class="o">.</span><span class="n">start_at</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
 <span class="n">hsm</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e1</span><span class="p">))</span>
 <span class="n">hsm</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">))</span>
 <span class="n">hsm</span><span class="o">.</span><span class="n">complete_circuit</span><span class="p">()</span>
</pre></div>
</div>
<p>Terminal output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>a1 ENTRY_SIGNAL
a1 INIT_SIGNAL
b1 ENTRY_SIGNAL
b1 INIT_SIGNAL
a1 e1
c1 ENTRY_SIGNAL
c1 INIT_SIGNAL
c1 e2
a1 ENTRY_SIGNAL
b1 ENTRY_SIGNAL
b1 INIT_SIGNAL
</pre></div>
</div>
<p>Now imagine we want to add some new behavior:</p>
<a class="reference external image-reference" href="_static/small_chart_new_behavior.pdf"><img alt="_images/small_chart_new_behavior.svg" class="noscale-center" src="_images/small_chart_new_behavior.svg" /></a>
<p>The code to do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b1_e2_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;c1&quot;</span><span class="p">)</span>
<span class="c1"># this will work because e2 is not registered the b1 state</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">b1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">b1_e2_hh</span><span class="p">,</span> <span class="n">suggest_behavior</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">hsm</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">))</span>
<span class="n">hsm</span><span class="o">.</span><span class="n">complete_circuit</span><span class="p">()</span>
</pre></div>
</div>
<p>Terminal output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>b1 e2
c1 ENTRY_SIGNAL
c1 INIT_SIGNAL
</pre></div>
</div>
<p>To over-write some existing behavior:</p>
<a class="reference external image-reference" href="_static/small_chart_impose_.pdf"><img alt="_images/small_chart_impose_behavior.svg" class="noscale-center" src="_images/small_chart_impose_behavior.svg" /></a>
<p>The code to do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c1_e2_hh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">template_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;a1&quot;</span><span class="p">)</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">c1_e2_hh</span><span class="p">)</span>
<span class="n">hsm</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">))</span>
<span class="n">hsm</span><span class="o">.</span><span class="n">complete_circuit</span><span class="p">()</span>
</pre></div>
</div>
<p>Terminal output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>c1 e2
a1 ENTRY_SIGNAL
a1 INIT_SIGNAL
b1 ENTRY_SIGNAL
b1 INIT_SIGNAL
</pre></div>
</div>
<p>Now suppose we want to change the hsm’s behavior, but we don’t want to have to
manipulate it’s state to test it, we just want the state to describe its
specification so we can read it.</p>
<p>Let’s read the c1 state specification, remove the e2 behavior then read the c1
state specification again:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;c1 specification before removal</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parse_spec</span><span class="p">(</span><span class="n">c1</span><span class="p">(</span><span class="n">specification</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;removing e2:</span><span class="si">{}</span><span class="s2"> from c1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">))</span>
<span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">remove_behavior</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;c1 specification after removal</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">parse_spec</span><span class="p">(</span><span class="n">c1</span><span class="p">(</span><span class="n">specification</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
</pre></div>
</div>
<p>Terminal output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> c1 specification before removal

 c1:&lt;<span class="k">function</span> orthogonal_state.&lt;locals&gt;._pspy_on at 0x7f72f1eba598&gt;
 top:&lt;bound method HsmEventProcessor.top of &lt;miros.hsm.HsmWithQueues object at 0x7f72f1556ac8&gt;&gt;
    ENTRY_SIGNAL:1 -&gt; c1:functools.partial<span class="o">(</span>&lt;<span class="k">function</span> __template_handler at 0x7f72f1eb2bf8&gt;, <span class="nv">state_function_name</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span>, <span class="nv">signal</span><span class="o">=</span><span class="m">1</span>, <span class="nv">handler</span><span class="o">=</span>functools.partial<span class="o">(</span>&lt;<span class="k">function</span> template_handled at 0x7f72f1eb2d08&gt;<span class="o">))</span>
    INIT_SIGNAL:3 -&gt; c1:functools.partial<span class="o">(</span>&lt;<span class="k">function</span> __template_handler at 0x7f72f1eb2bf8&gt;, <span class="nv">state_function_name</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span>, <span class="nv">signal</span><span class="o">=</span><span class="m">3</span>, <span class="nv">handler</span><span class="o">=</span>functools.partial<span class="o">(</span>&lt;<span class="k">function</span> template_handled at 0x7f72f1eb2d08&gt;<span class="o">))</span>
    e2:12 -&gt; c1:functools.partial<span class="o">(</span>&lt;<span class="k">function</span> __template_handler at 0x7f72f1eb2bf8&gt;, <span class="nv">state_function_name</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span>, <span class="nv">signal</span><span class="o">=</span><span class="m">12</span>, <span class="nv">handler</span><span class="o">=</span>functools.partial<span class="o">(</span>&lt;<span class="k">function</span> template_trans at 0x7f72f1eb2c80&gt;, <span class="nv">trans</span><span class="o">=</span><span class="s1">&#39;a1&#39;</span><span class="o">))</span>

removing e2:12 from c1

c1 specification after removal

c1:&lt;<span class="k">function</span> orthogonal_state.&lt;locals&gt;._pspy_on at 0x7f72f1eba7b8&gt;
top:&lt;bound method HsmEventProcessor.top of &lt;miros.hsm.HsmWithQueues object at 0x7f72f1556ac8&gt;&gt;
    ENTRY_SIGNAL:1 -&gt; c1:functools.partial<span class="o">(</span>&lt;<span class="k">function</span> __template_handler at 0x7f72f1eb2bf8&gt;, <span class="nv">state_function_name</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span>, <span class="nv">signal</span><span class="o">=</span><span class="m">1</span>, <span class="nv">handler</span><span class="o">=</span>functools.partial<span class="o">(</span>&lt;<span class="k">function</span> template_handled at 0x7f72f1eb2d08&gt;<span class="o">))</span>
    INIT_SIGNAL:3 -&gt; c1:functools.partial<span class="o">(</span>&lt;<span class="k">function</span> __template_handler at 0x7f72f1eb2bf8&gt;, <span class="nv">state_function_name</span><span class="o">=</span><span class="s1">&#39;c1&#39;</span>, <span class="nv">signal</span><span class="o">=</span><span class="m">3</span>, <span class="nv">handler</span><span class="o">=</span>functools.partial<span class="o">(</span>&lt;<span class="k">function</span> template_handled at 0x7f72f1eb2d08&gt;<span class="o">))</span>
</pre></div>
</div>
<p>I have demonstrated that the state functions can be constructed from templates.
These state’s can have their topological information added and their behaviors
adjusted by just calling them with instructions (they rebuild themselves
internally).  This can all be done before or while the state machine has been
running.</p>
<p>Here is the code which allowed this syntax to work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">HsmWithQueues</span>
<span class="kn">from</span> <span class="nn">miros</span> <span class="kn">import</span> <span class="n">return_status</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="n">module_namespace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>

<span class="n">SignalAndFunction</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;SignalAndFunction&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;signal&quot;</span><span class="p">,</span> <span class="s2">&quot;function&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">StateSpecification</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
    <span class="s2">&quot;StateSpecification&quot;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="s2">&quot;super_state&quot;</span><span class="p">,</span> <span class="s2">&quot;super_state_name&quot;</span><span class="p">,</span> <span class="s2">&quot;signal_function_list&quot;</span><span class="p">],</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">orthogonal_state</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;stand in for the orthogonal_state instrumentation decorator&#39;&#39;&#39;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_pspy_on</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">status</span>

    <span class="k">return</span> <span class="n">_pspy_on</span>


<span class="k">def</span> <span class="nf">token_match</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;stand in for token_match function&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">me</span> <span class="o">==</span> <span class="n">other</span>


<span class="k">def</span> <span class="nf">parse_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;map a state function spec onto a string&#39;&#39;&#39;</span>
    <span class="n">function_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="n">result</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">function</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">super_state_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">super_state</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">signal_function_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">signal_function_list</span><span class="p">:</span>
            <span class="n">function_name</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">sn</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">name_for_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sn</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">signal</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">function</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">__template_state</span><span class="p">(</span>
    <span class="n">hsm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sfl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">super_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">this_function_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remove_behavior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">suggested_behavior</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">specification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A function which can create itself.</span>

<span class="sd">    Use this to build and run states in a state machine.</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``hsm=None`` (HsmWithQueues): object with an event processor</span>
<span class="sd">       | ``e=None`` (Event): event</span>
<span class="sd">       | ``sfl=None`` ([]): signal function list</span>
<span class="sd">       | ``*``:  all arguments from now on have to be named</span>
<span class="sd">       | ``super_state=None`` (fn): the super state of this state in the hsm</span>
<span class="sd">       | ``this_function_name=None`` (str): this function name</span>
<span class="sd">       | ``imposed_behavior=None`` (bool|SignalAndFunction): a spec of imposed behavior</span>
<span class="sd">       | ``remove_behavior=None`` (bool|SignalAndFunction): a spec of behavior to remove</span>
<span class="sd">       | ``suggested_behavior=None`` (bool|SignalAndFunction): a spec of suggested behavior</span>
<span class="sd">       | ``specification=None`` (bool): to indicate you want the function to provide its spec</span>
<span class="sd">       | ``signal=None`` (int): signal (used with imposed_behavior,</span>
<span class="sd">       |                        remove_behavior, suggested behavior args)</span>
<span class="sd">       | ``handler=None`` (callable): the callable handler which is associated</span>
<span class="sd">       |                              with a behavior, (used with</span>
<span class="sd">       |                              imposed_behavior and suggested_behavior</span>
<span class="sd">       |                              args)</span>
<span class="sd">       | ``**kwargs``: arbitrary keyword arguments</span>



<span class="sd">    **Returns**:</span>
<span class="sd">       (return_status|fn|StateSpecification|str):</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      from miros import Event</span>
<span class="sd">      from miros import signals</span>
<span class="sd">      from functools import partial</span>
<span class="sd">      from miros import HsmWithQueues</span>

<span class="sd">      #  +-------------- a ---------------+</span>
<span class="sd">      #  |                                |</span>
<span class="sd">      #  |    +-------b----------+        |</span>
<span class="sd">      #  |    | entry /          |        |</span>
<span class="sd">      #  | *--&gt;  print(&#39;hello&#39;)  |        |       +-----c-----+</span>
<span class="sd">      #  |    |                  |        |       |           |</span>
<span class="sd">      #  |    |                  |        +---e1--&gt;           |</span>
<span class="sd">      #  |    |                  |&lt;-------e2------+           |</span>
<span class="sd">      #  |    +------------------+        |       +-----------+</span>
<span class="sd">      #  |                                |</span>
<span class="sd">      #  +--------------------------------+</span>

<span class="sd">      # these will be the state handlers</span>
<span class="sd">      def template_trans(hsm, e, state_name=None, *, trans=None, **kwargs):</span>
<span class="sd">          status = return_status.HANDLED</span>
<span class="sd">          assert trans</span>
<span class="sd">          print(&quot;{} {}&quot;.format(state_name, e.signal_name))</span>
<span class="sd">          status = hsm.trans(getattr(module_namespace, trans))</span>
<span class="sd">          return status</span>

<span class="sd">      def template_handled(hsm, e, state_name=None, **kwargs):</span>
<span class="sd">          status = return_status.HANDLED</span>
<span class="sd">          print(&quot;{} {}&quot;.format(state_name, e.signal_name))</span>
<span class="sd">          return status</span>

<span class="sd">      hsm = HsmWithQueues()</span>
<span class="sd">      a1 = partial(__template_state, this_function_name=&quot;a1&quot;, super_state=hsm.top)()</span>
<span class="sd">      b1 = partial(__template_state, this_function_name=&quot;b1&quot;, super_state=a1)()</span>
<span class="sd">      c1 = partial(__template_state, this_function_name=&quot;c1&quot;, super_state=hsm.top)()</span>

<span class="sd">      a1_entry_hh = partial(template_handled)</span>
<span class="sd">      a1_init_hh = partial(template_trans, trans=&quot;b1&quot;)</span>
<span class="sd">      a1_e1_hh = partial(template_trans, trans=&quot;c1&quot;)</span>

<span class="sd">      a1 = a1(hsm=hsm, signal=signals.ENTRY_SIGNAL, handler=a1_entry_hh)</span>
<span class="sd">      a1 = a1(hsm=hsm, signal=signals.INIT_SIGNAL, handler=a1_init_hh)</span>
<span class="sd">      a1 = a1(hsm=hsm, signal=signals.e1, handler=a1_e1_hh)</span>

<span class="sd">      b1_entry_hh = partial(template_handled)</span>
<span class="sd">      b1_init_hh = partial(template_handled)</span>

<span class="sd">      b1 = b1(hsm=hsm, signal=signals.ENTRY_SIGNAL, handler=b1_entry_hh)</span>
<span class="sd">      b1 = b1(hsm=hsm, signal=signals.INIT_SIGNAL, handler=b1_init_hh)</span>

<span class="sd">      c1_entry_hh = partial(template_handled)</span>
<span class="sd">      c1_init_hh = partial(template_handled)</span>
<span class="sd">      c1_e2_hh = partial(template_trans, trans=&quot;b1&quot;)</span>

<span class="sd">      c1 = c1(hsm=hsm, signal=signals.ENTRY_SIGNAL, handler=c1_entry_hh)</span>
<span class="sd">      c1 = c1(hsm=hsm, signal=signals.INIT_SIGNAL, handler=c1_init_hh)</span>
<span class="sd">      c1 = c1(hsm=hsm, signal=signals.e2, handler=c1_e2_hh)</span>

<span class="sd">      # Run our hsm</span>
<span class="sd">      hsm.start_at(a1)</span>
<span class="sd">      hsm.post_fifo(Event(signal=signals.e1))</span>
<span class="sd">      hsm.post_fifo(Event(signal=signals.e2))</span>
<span class="sd">      hsm.complete_circuit()</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">):</span>
            <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imposed_behavior</span><span class="p">,</span> <span class="n">SignalAndFunction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sfl</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sfl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sfl</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">SignalAndFunction</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sfl</span>
                <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="n">imposed_behavior</span><span class="o">.</span><span class="n">signal</span>
            <span class="p">]</span>
            <span class="n">sfl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imposed_behavior</span><span class="p">)</span>
            <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">remove_behavior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">remove_behavior</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">behavior</span> <span class="o">=</span> <span class="n">SignalAndFunction</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)(</span>
                    <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">remove_behavior</span><span class="o">=</span><span class="n">behavior</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">signal</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">:</span>
            <span class="n">function</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">__template_handler</span><span class="p">,</span>
                <span class="n">state_function_name</span><span class="o">=</span><span class="n">this_function_name</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">behavior</span> <span class="o">=</span> <span class="n">SignalAndFunction</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">suggested_behavior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">suggested_behavior</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)(</span>
                    <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">suggested_behavior</span><span class="o">=</span><span class="n">behavior</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">imposed_behavior</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">imposed_behavior</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)(</span>
                    <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span> <span class="n">imposed_behavior</span><span class="o">=</span><span class="n">behavior</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_behavior</span><span class="p">,</span> <span class="n">SignalAndFunction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sfl</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sfl</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">SignalAndFunction</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sfl</span>
                    <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="n">remove_behavior</span><span class="o">.</span><span class="n">signal</span>
                <span class="p">]</span>
            <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">suggested_behavior</span><span class="p">,</span> <span class="n">SignalAndFunction</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sfl</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">SignalAndFunction</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">)</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sfl</span>
                            <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="n">suggested_behavior</span><span class="o">.</span><span class="n">signal</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">&gt;=</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="c1"># the signal is already there, we are ignoring your request</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... ignoring&quot;</span><span class="p">)</span>
                    <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">sfl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suggested_behavior</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rebuild_function</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">__template_state</span><span class="p">,</span>
                <span class="n">sfl</span><span class="o">=</span><span class="n">sfl</span><span class="p">,</span>
                <span class="n">super_state</span><span class="o">=</span><span class="n">super_state</span><span class="p">,</span>
                <span class="n">this_function_name</span><span class="o">=</span><span class="n">this_function_name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">this_function_name</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">orthogonal_state</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">this_function_name</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hsm</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hsm</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">hsm</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">this_function_name</span><span class="p">:</span>
                        <span class="n">hsm</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fn</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hsm</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">hsm</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">this_function_name</span><span class="p">:</span>
                        <span class="n">hsm</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fn</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">specification</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">StateSpecification</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">),</span>
                <span class="n">super_state</span><span class="o">=</span><span class="n">super_state</span><span class="p">,</span>
                <span class="n">super_state_name</span><span class="o">=</span><span class="n">super_state</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="n">signal_function_list</span><span class="o">=</span><span class="n">sfl</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">spec</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">GET_STATE_SPEC</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">StateSpecification</span><span class="p">(</span>
            <span class="n">function</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">),</span>
            <span class="n">super_state</span><span class="o">=</span><span class="n">super_state</span><span class="p">,</span>
            <span class="n">super_state_name</span><span class="o">=</span><span class="n">super_state</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">signal_function_list</span><span class="o">=</span><span class="n">sfl</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">spec</span>
    <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">REFLECTION_SIGNAL</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">this_function_name</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sfl</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span> <span class="ow">in</span> <span class="n">sfl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token_match</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">function</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">hsm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state_function_name</span><span class="o">=</span><span class="n">this_function_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hsm</span><span class="o">.</span><span class="n">top</span> <span class="o">==</span> <span class="n">super_state</span><span class="p">:</span>
            <span class="n">hsm</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">super_state</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hsm</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">super_state</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
    <span class="k">return</span> <span class="n">status</span>


<span class="k">def</span> <span class="nf">__template_handler</span><span class="p">(</span>
    <span class="n">hsm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">state_function_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">this_function_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">signal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">specification</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">get_state_function_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is intended to be used by the ``__template_state``.</span>

<span class="sd">    A template for building event and handler functions, once it is built, it</span>
<span class="sd">    will serve as a function to call when its state function receives a specific</span>
<span class="sd">    signal: ex. ``signals.ENTRY_SIGNAL``</span>

<span class="sd">    **Args**:</span>
<span class="sd">       | ``hsm=None`` (HsmWithQueues): object with an event processor</span>
<span class="sd">       | ``e=None`` (Event): event</span>
<span class="sd">       | ``handler=None`` (callable): the callable handler</span>
<span class="sd">       | ``*`` all arguments from now on have to be named:</span>
<span class="sd">       | ``state_function_name=None`` (str): what state I&#39;m associated with</span>
<span class="sd">       | ``this_function_name=None`` (str): this function name</span>
<span class="sd">       | ``signal=None`` (int): the signal I&#39;m associated with</span>
<span class="sd">       | ``specification=None`` (bool): should I output by spec?</span>
<span class="sd">       | ``get_state_function_name=None`` (str): get the state function name</span>
<span class="sd">       | ``**kwargs``: arbitrary keyword arguements</span>


<span class="sd">    **Returns**:</span>
<span class="sd">       (return_status|fn|StateSpecification|str):</span>

<span class="sd">    **Example(s)**:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">      def template_handled(hsm, e, state_name=None, **kwargs):</span>
<span class="sd">          status = return_status.HANDLED</span>
<span class="sd">          print(&quot;{} {}&quot;.format(state_name, e.signal_name))</span>
<span class="sd">          return status</span>

<span class="sd">      a1_entry_h = partial(template_handled)</span>

<span class="sd">      # here we are using this function</span>
<span class="sd">      behavior = SignalAndFunction(</span>
<span class="sd">        __template_state,</span>
<span class="sd">        state_method_name=&#39;a1&#39;,</span>
<span class="sd">        signal=signals.ENTRY_SIGNAL,</span>
<span class="sd">        handler=a1_entry_h)</span>

<span class="sd">      # build a state</span>
<span class="sd">      a1 = partial(__template_state, this_function_name=&quot;a1&quot;, super_state=hsm.top)()</span>

<span class="sd">      # now we impose the behavior</span>
<span class="sd">      a1(imposed_behavior=behavior)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">get_state_function_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_function_name</span>

        <span class="k">if</span> <span class="n">this_function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">this_function_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">state_function_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">signals</span><span class="o">.</span><span class="n">name_for_signal</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">):</span>
            <span class="n">rebuild_function</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">rebuild_function</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
                <span class="n">__template_handler</span><span class="p">,</span>
                <span class="n">this_function_name</span><span class="o">=</span><span class="n">this_function_name</span><span class="p">,</span>
                <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
                <span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">this_function_name</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">specification</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">SignalAndFunction</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">),</span> <span class="n">signal</span><span class="o">=</span><span class="n">signal</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">spec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">GET_STATE_SPEC</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">SignalAndFunction</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">),</span> <span class="n">signal</span><span class="o">=</span><span class="n">signal</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">spec</span>

    <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">this_function_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">hsm</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">state_function_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
            ← <a class="relational-link" href="quickstart.html" title="previous chapter">Getting Your Head in the Project</a>
            
          </div>
          <div>
            
             <a class="relational-link" href="how_it_works.html" title="next chapter">How it Works</a> →
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Jan 18, 2021 10:21 PM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.4.0 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>