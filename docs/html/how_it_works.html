







<!DOCTYPE html>
<html  lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>How it Works | miros-xml</title>
    <link rel="shortcut icon" href="_static/favicon.ico">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css">
    <link rel="stylesheet" href="_static/theme.css" type="text/css">
    
    

    
    <script type="text/javascript" src="_static/theme.js" defer></script>
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    
    <script src="_static/jquery.js"></script>
    
    <script src="_static/underscore.js"></script>
    
    <script src="_static/doctools.js"></script>
    
    

    
      
      
    <link rel="index" title="Index" href="genindex.html">
      
      
    <link rel="search" title="Search" href="search.html">
      
      
      
      
    <link rel="prev" title="Techniques" href="techniques.html">
      
    

    

    

    
  </head>

  <body>
    <header class="main-header">
      <div class="navbar">
        <div id="js-sidebar-mask" class="sidebar-mask"></div>
        <div id="js-sidebar-menu-button" class="sidebar-menu-button">
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg>
        </div>
        <a href="index.html" class="site-link">
          
          miros-xml
          
        </a>
        <div class="navbar-links">
          <a href="installation.html" class="navbar-link">Docs</a>
          
          <a href="https://github.com/aleph2c/miros-xml" class="navbar-link">GitHub</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
          
        </div>
      </div>
    </header>

    <main class="main-wrapper">
      
      <div id="js-main-sidebar" class="main-sidebar">
        
        <div class="sidebar-content sidebar-content--divider sidebar-navbar-links">
          <a href="https://github.com/aleph2c/miros-xml" class="sidebar-navbar-link">GitHub</a>
          <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg>
        </div>
        
        
        <h3 class="sidebar-heading">About</h3>
<ul>
  <li>XML for <a "https://github.com/aleph2c/miros">miros</a> 
</ul>
        
        

<h2 class="sidebar-heading">Contents</h2>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Getting Your Head in the Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="techniques.html">Techniques</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">How it Works</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#context-and-design-goal">Context and Design Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#structure-of-the-code">Structure of the Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-the-region-class-relates-to-the-parallel-region-drawing">How the Region Class Relates to the Parallel Region Drawing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-the-regions-class-organizes-a-graph-of-region-objects">How the Regions Class Organizes a Graph of Region Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#injector-state-functions-region-objects-and-regions-objects-in-a-graph">Injector State Functions, Region Objects and Regions Objects in a Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-the-xmlchart-organizes-its-regions">How the XmlChart Organizes its Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hidden-states-and-what-they-are-for">Hidden States and What They are For</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-the-parallel-region-is-mapped-onto-the-orthogonal-component">How the Parallel-Region is mapped onto the Orthogonal Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wtf-transitions-meta-events-and-transitions-across-parallel-regions">WTF Transitions, Meta Events and Transitions Across Parallel Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-1">A Walk through of a WTF Transition, Case 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-2">A Walk through of a WTF Transition, Case 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-3">A Walk through of a WTF Transition, Case 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-systematic-way-of-naming-wtf-events">Creating a Systematic way of Naming WTF Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="#beastiary">Beastiary</a></li>
<li class="toctree-l2"><a class="reference internal" href="#construction-tactics">Construction Tactics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reflection-and-logging">Reflection and Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#building-a-subregion">Building a Subregion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#writing-wtf-events-across-regions">Writing WTF Events Across Regions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#hidden-dynamics">Hidden Dynamics</a></li>
</ul>
</li>
</ul>

        
        <h3 class="sidebar-heading">Useful Links</h3>
  <ul>
    <li><a href="https://aleph2c.github.io/miros-rabbitmq/html/index.html">miros on github</a></li>
    <li><a href="https://github.com/aleph2c/sequence">sequence on
        github</a></li>
    <li><a
          href="https://aleph2c.github.io/miros-rabbitmq/html/index.html">miros-rabbitmq
          plugin</a></li>
    <li><a href="http://www.umlet.com">UMLet Download</a></li>
    <li><a
          href="http://www.inf.ed.ac.uk/teaching/courses/seoc/2005_2006/resources/statecharts.pdf">formalism
          explained</a></li>
  </ul>
<h3 class="sidebar-heading">Statechart Videos</h3>
  <ul>
    <li><a href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 1 (What)</a></li> 
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-why-use-them-2-of-4-90489.html">Part 2 (Why)</a></li>
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-what-are-they-1-of-4-90488.html">Part 3 (Mealy/Moore)</a></li>
    <li><a
          href="https://www.mathworks.com/videos/understanding-state-machines-harel-state-machines-4-of-4-90491.html">Part 4 (Harel Statecharts)</a></li>
    <li><a href="https://barrgroup.com/Embedded-Systems/How-To/Introduction-Hierarchical-State-Machines">Introduction to HSMs</a></li>
</ul>
        
        

<div id="searchbox" style="display: none" role="search">
  <h2 id="searchlabel" class="sidebar-heading">Quick search</h2>
  <div class="searchformwrapper sidebar-content">
    <form class="search" action="search.html" method="get">
      <input class="sidebar-search sidebar-search--input" type="text" name="q" aria-labelledby="searchlabel"><input class="sidebar-search sidebar-search--btn" type="submit" value="Go">
    </form>
  </div>
</div>
<script>$('#searchbox').show(0);</script>

        
      </div>
      

      
      <div class="main-content main-content--sidebar">
      
        
          
  <blockquote>
<div><p>Debugging is twice as hard as writing the code in the first place.  Therefore,
if you write the code as cleverly as possible, you are, by definition, not smart
enough to debug it.  – <strong>Brian Kernighan.</strong></p>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This portion of the document is a collection of notes I have been taking as I
write the software.  It is me, writing to think through the problem.  It is
not meant for general consumption, since a lot of the words/definitions used
to describe the system are inconsistent; it’s a work in progress.</p>
<p>But if you would like to follow this document, first make sure you have a
firm understanding of the miros library.</p>
</div>
<div class="section" id="how-it-works">
<span id="id1"></span><h1>How it Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline">#</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#context-and-design-goal" id="id4">Context and Design Goal</a></p></li>
<li><p><a class="reference internal" href="#structure-of-the-code" id="id5">Structure of the Code</a></p></li>
<li><p><a class="reference internal" href="#how-the-region-class-relates-to-the-parallel-region-drawing" id="id6">How the Region Class Relates to the Parallel Region Drawing</a></p></li>
<li><p><a class="reference internal" href="#how-the-regions-class-organizes-a-graph-of-region-objects" id="id7">How the Regions Class Organizes a Graph of Region Objects</a></p></li>
<li><p><a class="reference internal" href="#injector-state-functions-region-objects-and-regions-objects-in-a-graph" id="id8">Injector State Functions, Region Objects and Regions Objects in a Graph</a></p></li>
<li><p><a class="reference internal" href="#how-the-xmlchart-organizes-its-regions" id="id9">How the XmlChart Organizes its Regions</a></p></li>
<li><p><a class="reference internal" href="#hidden-states-and-what-they-are-for" id="id10">Hidden States and What They are For</a></p></li>
<li><p><a class="reference internal" href="#how-the-parallel-region-is-mapped-onto-the-orthogonal-component" id="id11">How the Parallel-Region is mapped onto the Orthogonal Component</a></p></li>
<li><p><a class="reference internal" href="#wtf-transitions-meta-events-and-transitions-across-parallel-regions" id="id12">WTF Transitions, Meta Events and Transitions Across Parallel Regions</a></p></li>
<li><p><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-1" id="id13">A Walk through of a WTF Transition, Case 1</a></p></li>
<li><p><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-2" id="id14">A Walk through of a WTF Transition, Case 2</a></p></li>
<li><p><a class="reference internal" href="#a-walk-through-of-a-wtf-transition-case-3" id="id15">A Walk through of a WTF Transition, Case 3</a></p></li>
<li><p><a class="reference internal" href="#creating-a-systematic-way-of-naming-wtf-events" id="id16">Creating a Systematic way of Naming WTF Events</a></p></li>
<li><p><a class="reference internal" href="#beastiary" id="id17">Beastiary</a></p></li>
<li><p><a class="reference internal" href="#construction-tactics" id="id18">Construction Tactics</a></p>
<ul>
<li><p><a class="reference internal" href="#experimental-files" id="id19">Experimental Files</a></p></li>
<li><p><a class="reference internal" href="#naming-conventions" id="id20">Naming Conventions</a></p></li>
<li><p><a class="reference internal" href="#automatic-construction-of-hidden-states" id="id21">Automatic Construction of Hidden States</a></p></li>
<li><p><a class="reference internal" href="#automatic-construction-of-injectors" id="id22">Automatic Construction of Injectors</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#reflection-and-logging" id="id23">Reflection and Logging</a></p>
<ul>
<li><p><a class="reference internal" href="#souped-up-spy" id="id24">Souped Up Spy</a></p></li>
<li><p><a class="reference internal" href="#souped-up-state-name-reflection" id="id25">Souped Up State Name Reflection</a></p></li>
<li><p><a class="reference internal" href="#simplifying-the-inner-injector-functions" id="id26">Simplifying the Inner Injector Functions</a></p></li>
<li><p><a class="reference internal" href="#reading-the-log-file" id="id27">Reading the Log File</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#building-a-subregion" id="id28">Building a Subregion</a></p></li>
<li><p><a class="reference internal" href="#writing-wtf-events-across-regions" id="id29">Writing WTF Events Across Regions</a></p>
<ul>
<li><p><a class="reference internal" href="#e-wtf-events" id="id30">E WTF Events</a></p></li>
<li><p><a class="reference internal" href="#e0-wtf-event" id="id31">E0 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#e1-wtf-event" id="id32">E1 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#e2-wtf-event" id="id33">E2 WTF Event</a></p></li>
<li><p><a class="reference internal" href="#c-wtf-events" id="id34">C WTF Events</a></p></li>
<li><p><a class="reference internal" href="#c0-wtf-event" id="id35">C0 WTF Event</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#hidden-dynamics" id="id36">Hidden Dynamics</a></p></li>
</ul>
</div>
<div class="section" id="context-and-design-goal">
<span id="how-it-works-subsection-title"></span><h2>Context and Design Goal<a class="headerlink" href="#context-and-design-goal" title="Permalink to this headline">#</a></h2>
<p>Here is an example of a statechart diagram written using David Harel’s parallel
region’s drawing technique:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>The state machines separated from one another with dashed lines are said to be
running in “parallel regions”.  This means any event seen by the whole machine
will be seen by each region and both regions are expected to run concurrently as
if they were running on their own computer.  A statechart which supports the
parallel region pattern can have one or more active state at a time.  The event
processing algorithm used by miros does not support the parallel regions
pattern.</p>
<p>But miros <em>does</em> support the ability to place an HSM within another HSM.  This
is called the “orthogonal component” pattern (an HSM in an HSM).  Since the
state of an inner HSM is in a different state than the outer machine which holds
it, the orthogonal component pattern can have more than one active state like
the parallel region pattern.</p>
<p>The goal of this documentation is to show how to map the orthogonal component
pattern onto the parallel region pattern.</p>
</div>
<div class="section" id="structure-of-the-code">
<span id="how-it-works-structure-of-the-code"></span><h2>Structure of the Code<a class="headerlink" href="#structure-of-the-code" title="Permalink to this headline">#</a></h2>
<p>From a very high level the code is structured like this:</p>
<a class="reference external image-reference" href="_static/class_relationships.pdf"><img alt="_images/class_relationships.svg" class="noscale-center" src="_images/class_relationships.svg" /></a>
<p>The “orthogonal components” will be the Region objects described in the diagram
above.  An “orthogonal component” is another name for an HSM inside of another
HSM.  So our Region objects will have to run within another HSM.  They will
either run within the outmost XmlChart statechart object or within another
Region object.</p>
<p>The Region class is derived from the HsmWithQueues class. HsmWithQueues objects
don’t have their own threads to watch for incoming events so neither will any
Region object.  The outmost XmlChart’s thread will have to watch for new events
in its queue, then begin the process of driving these events deeper and deeper
into its inner region objects.</p>
<p>The management, communication and graphical organization of all of the Region
objects, relative to one another, will be managed by a Regions object.  Through
the Regions methods, any region can access the methods controlling other regions
it is adjacent to in the hierarchy of HSMs via the  <code class="docutils literal notranslate"><span class="pre">inner</span></code>, <code class="docutils literal notranslate"><span class="pre">same</span></code> and
<code class="docutils literal notranslate"><span class="pre">outer</span></code> attributes.</p>
<p>The XmlChart has many Regions and it inherits from the InstrumentedActiveObject
which is just an ActiveObject with some additional logging and customized
instrumentation features.  Since the XmlChart inherits from the ActiveObject, it
will have a thread and a set of queues which can receive events asynchronously
from programs running in other threads.  The thread of the XmlChart will drive
all of its inner hierarchical state machines, and it will filter and drive
events deeper and deeper into it’s architecture to perform the behaviors
specified by the Harel drawing formalism.</p>
<p>Each region object has access to the methods of the XmlChart object via their
<code class="docutils literal notranslate"><span class="pre">outmost</span></code> attribute.</p>
</div>
<div class="section" id="how-the-region-class-relates-to-the-parallel-region-drawing">
<span id="how-it-works-how-the-region-class-relates-to-the-parallel-region-drawing"></span><h2>How the Region Class Relates to the Parallel Region Drawing<a class="headerlink" href="#how-the-region-class-relates-to-the-parallel-region-drawing" title="Permalink to this headline">#</a></h2>
<p>There will be one Region object for every region in a diagram which supports the
dashed line notation:</p>
<a class="reference external image-reference" href="_static/region.pdf"><img alt="_images/region.svg" class="scale-to-fit" src="_images/region.svg" /></a>
<p>A Region is just an HsmWithQueues with some additional methods; so it’s just an
HSM.  The Region will be attached to a state machine who’s inner part is
identical to that in the parallel region diagram, but with three additional
outer states and event handlers.  These outer structures will be invisible to
the user, and will provide the means to control the orthogonal component so that
its inner state machine will behave as if it was a parallel state.  I will talk
more about these outer structures later, but for now know that they are just
there to map one technique onto another.</p>
<p>Parallel regions occur within a state.  A state function that needs to connect
to inner, embedded HSMs will use the Regions object to do this work.</p>
</div>
<div class="section" id="how-the-regions-class-organizes-a-graph-of-region-objects">
<span id="how-it-works-how-the-regions-class-organizes-a-graph-of-region-objects"></span><h2>How the Regions Class Organizes a Graph of Region Objects<a class="headerlink" href="#how-the-regions-class-organizes-a-graph-of-region-objects" title="Permalink to this headline">#</a></h2>
<p>The Regions object is constructed within the XmlChart class.  A Regions object
can construct and own many different region objects.</p>
<p>The Regions class can inject and drive events into all of the Region objects it
controls.</p>
<a class="reference external image-reference" href="_static/regions.pdf"><img alt="_images/regions.svg" class="scale-to-fit" src="_images/regions.svg" /></a>
<p>For an HHSM to work, a state function operating in one HSM (region) will have to
be able to drive events into other HSMs (other regions).  The Regions class
provides this ability: it allows a state function to drive events to inner, same
or outer levels of the layered HSM hierarchy.</p>
<p>Both the Regions objects and the outmost statechart object, XmlChart, have
<code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>, <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> and a host of other event control and driving
mechanisms.  Since the Regions class and the XmlChart class use the same names
for the methods that do this work, you can say they are polymorphic; they have
the same interface.  A state function will need to aim these methods at
different levels of the hierarchical HSM.</p>
<p>The Regions objects have limited graphical information.  They only know about
the “outer”, “same” and “inner” information of the Region objects they own:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">outmost</span></code>: The outer most statechart object. (green line)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">outer</span></code>: HSMs one layer out in the parallel regions diagram. (magenta line)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">same</span></code>: HSMs within the same parallel region. (orange line)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">inner</span></code>: HSMs mapping to an inner parallel region of the state. (red line)</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">outmost</span></code>, <code class="docutils literal notranslate"><span class="pre">outer</span></code> and <code class="docutils literal notranslate"><span class="pre">same</span></code> attributes will be linked to a Region
object at its moment of creation by the Regions object.  The <code class="docutils literal notranslate"><span class="pre">inner</span></code> attribute
is set dynamically because the <code class="docutils literal notranslate"><span class="pre">inner</span></code>
attribute is not something that will apply to an entire region object. The
region object will contain many different states in the region and only the
injector will need a connection to the inner region.  To see what I mean, look
at <code class="docutils literal notranslate"><span class="pre">&lt;&lt;x&gt;&gt;_region_state_1</span></code>, it will not have the same <code class="docutils literal notranslate"><span class="pre">inner</span></code> relation that
<code class="docutils literal notranslate"><span class="pre">p_state_function</span></code> will have to the parallel regions contained within
<code class="docutils literal notranslate"><span class="pre">p_state_function</span></code>.</p>
<p>But a function can’t really own anything in OO theory.  If you read the code you
will see that the <code class="docutils literal notranslate"><span class="pre">inner</span></code> attribute is assigned dynamically by a decorator.</p>
</div>
<div class="section" id="injector-state-functions-region-objects-and-regions-objects-in-a-graph">
<span id="injectors-2"></span><h2>Injector State Functions, Region Objects and Regions Objects in a Graph<a class="headerlink" href="#injector-state-functions-region-objects-and-regions-objects-in-a-graph" title="Permalink to this headline">#</a></h2>
<p>State functions have Regions objects which have Region objects which have state
functions.  This is all very confusing.  Seeing how things inter-relate in a
graph would be nice, but this is not supported with idiomatic UML.</p>
<p>So we will break the rules and describe their graphical relationship like so:</p>
<a class="reference external image-reference" href="_static/regions_in_regions.pdf"><img alt="_images/regions_in_regions.svg" class="noscale-center" src="_images/regions_in_regions.svg" /></a>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">r.outer.post_fifo(...)</span></code>: post to all HSMs one level up in the hierarchy (magenta line)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r.same.post_fifo(...)</span></code>: post to all HSMs at the same level of the hierarchy (orange line)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">r.inner.post_fifo(...)</span></code>: post to all inner HSMs in the state. (red line)</p></li>
</ul>
<p>Place your eyes on the outer most Regions object.  It has multiple region
objects.  Its top most region object drives a partially drawn HSM.  Within this
HSM is an <strong>injector</strong>, or a state function that has parallel regions within it.
This <strong>injector</strong> function is called p_p11.</p>
<p>The p_p11 injector function needs to control the collection of inner region
objects, so it makes <code class="docutils literal notranslate"><span class="pre">r.inner.post_fifo(...)</span></code> calls to do this.  By convention
the Regions object is given the same name as the injector which needs its
methods.</p>
<p>Now look within the regions being managed within the p_p11 Regions object.  If a
state machine inside of one of its orthogonal components needs to use the
<code class="docutils literal notranslate"><span class="pre">r.same.post_fifo(...)</span></code>, it will be posting and driving events through all of its sibling
orthogonal components.</p>
<p>There will be times when a state function needs to call to drive events through
its super-region or parent region components.  To do this it uses the
<code class="docutils literal notranslate"><span class="pre">r.outer.post_fifo(...)</span></code> syntax.</p>
<p>Not included on the above diagram is a posting to the outer statechart, this
would be done as <code class="docutils literal notranslate"><span class="pre">r.outmost.post_fifo(...)</span></code>.</p>
</div>
<div class="section" id="how-the-xmlchart-organizes-its-regions">
<span id="how-it-works-how-the-xmlchart-organizes-its-regions"></span><h2>How the XmlChart Organizes its Regions<a class="headerlink" href="#how-the-xmlchart-organizes-its-regions" title="Permalink to this headline">#</a></h2>
<a class="reference external image-reference" href="_static/XmlChart.pdf"><img alt="_images/XmlChart.svg" class="noscale-center" src="_images/XmlChart.svg" /></a>
<p>The XmlChart class is a statechart which has a bunch of Regions objects, which
in turn manage groups of orthogonal components (Region objects).  I have
discussed the inner dynamics already so I will focus now on how Regions
objects are organized within the XmlChart class: they are in a data dictionary.
This dictionary has key names that match the <strong>injector</strong> functions that own
them.</p>
<p>Each state function will receive a handle to its Region object and an event.
All Region objects will have an attribute that points to the outmost chart, the
XmlChart object.  It is through this reference that the Regions objects are
looked up to get the methods required to post and drive events to other regions.</p>
<p>The XmlChart is the only HSM in the whole system that has a thread.  This thread
must be used to drive all of the inner HSMs.  It acts like the spring drive in a
mechanical watch; it drives gears which drive smaller gears which drive smaller
gears.  Any event that is passed to our chart must first be managed by the
XmlChart class, then pushed into the inner Regions.  All <strong>injector</strong> functions
will also drive their received external events deeper and deeper into the chart
until the whole collective RTC event is finished.</p>
</div>
<div class="section" id="hidden-states-and-what-they-are-for">
<span id="how-it-works-hidden-states-and-what-they-are-for"></span><h2>Hidden States and What They are For<a class="headerlink" href="#hidden-states-and-what-they-are-for" title="Permalink to this headline">#</a></h2>
<p>The state machines inside of a Region will mostly look the same as how they will
look on a David Harel diagram, or how they are structured within the &lt;p&gt; tag of
the XML.  But for the mapping of one pattern onto another, three additional
states wrap the state-machine within a parallel region.  See the diagram below:</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_1.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_1.svg" class="noscale-center" src="_images/parallel_region_to_orthogonal_component_mapping_1.svg" /></a>
<p>The wrapper states are described here:</p>
<ul class="simple">
<li><p>The <strong>under_hidden_region</strong> state presents the illusion that our region can be
exited.  The orthogonal component pattern allows us an HSM within an HSM, but
the parallel pattern needs a whole region to exit when it turns off.  This
exiting behavior is captured by this <strong>under_hidden_region</strong>.</p></li>
<li><p>The <strong>region</strong> state is sandwiched between the under and over hidden states.
It contains an <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> handler which can either cause a transition to
the default state (see p1_s11 in the diagram) or it can be aimed
programmatically.</p></li>
<li><p>The <strong>over_hidden</strong> state’s sole purpose is to cause a re-initialization event
from any of it’s substates, so that the programmable init arrow of the region
state can be run any time.</p></li>
</ul>
<p>Here we see how the parallel region is mapped onto the orthogonal component with a
bit more detail about the Regions object and Region objects:</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_2.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_2.svg" class="noscale-center" src="_images/parallel_region_to_orthogonal_component_mapping_2.svg" /></a>
</div>
<div class="section" id="how-the-parallel-region-is-mapped-onto-the-orthogonal-component">
<span id="how-it-works-how-the-parallel-region-is-mapped-onto-the-orthogonal-component"></span><h2>How the Parallel-Region is mapped onto the Orthogonal Component<a class="headerlink" href="#how-the-parallel-region-is-mapped-onto-the-orthogonal-component" title="Permalink to this headline">#</a></h2>
<p>To get events into the inner regions of the chart you must pass them via the
<strong>injectors</strong> (p in this diagram):</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_3.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_3.svg" class="noscale-center" src="_images/parallel_region_to_orthogonal_component_mapping_3.svg" /></a>
<p>From the top diagram we can see how the bottom diagram should work.  If we start
the chart in the outer_state, send a <code class="docutils literal notranslate"><span class="pre">to_p</span></code>, then send an <code class="docutils literal notranslate"><span class="pre">e1</span></code>,  the active
states should be <code class="docutils literal notranslate"><span class="pre">['p_s12',</span> <span class="pre">'...']</span></code>.</p>
<p>Now look at how an event is injected into a parallel region inside of another parallel region:</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_4.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_4.svg" class="noscale-center" src="_images/parallel_region_to_orthogonal_component_mapping_4.svg" /></a>
<p>If we start the chart in the outer_state, send a <code class="docutils literal notranslate"><span class="pre">to_p</span></code>, then send an <code class="docutils literal notranslate"><span class="pre">e1</span></code>,
the chart should settle into <code class="docutils literal notranslate"><span class="pre">[['p_p11_s12',</span> <span class="pre">'...'],</span> <span class="pre">'...']</span></code>.</p>
<p>From this simple exercise we can see how the pictorial-descriptive-power of the
orthogonal components is being completely outclassed by the Harel-parallel-regions
drawing technique.</p>
<p>Now imagine the orthogonal component diagram for this:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>I could draw it, but it would stop being useful.</p>
<p>Now imagine trying to draw the above using finite state machines.  It may be
possible, but I know I wouldn’t want to do it, and I certainly wouldn’t want to
maintain the diagram and its code base.</p>
</div>
<div class="section" id="wtf-transitions-meta-events-and-transitions-across-parallel-regions">
<span id="how-it-works-wtf-transitions-meta-events-and-transitions-across-parallel-regions"></span><h2>WTF Transitions, Meta Events and Transitions Across Parallel Regions<a class="headerlink" href="#wtf-transitions-meta-events-and-transitions-across-parallel-regions" title="Permalink to this headline">#</a></h2>
<p>I named the transitions across parallel regions WTF transitions (or WTF events),
because initially I had no idea how to implement them.  Eventually I discovered
a way to get them working: I made events which carried other events which could
react to custom event handlers written into many of the state functions.</p>
<p>Since an event carrying information about another event in its payload is a kind
of meta phenomenon, I decided to call these events, meta-events.</p>
</div>
<div class="section" id="a-walk-through-of-a-wtf-transition-case-1">
<span id="how-it-works-a-walk-through-of-a-wtf-transition-case-1"></span><h2>A Walk through of a WTF Transition, Case 1<a class="headerlink" href="#a-walk-through-of-a-wtf-transition-case-1" title="Permalink to this headline">#</a></h2>
<p>Here is a walk through of our first WFT transition: <code class="docutils literal notranslate"><span class="pre">E0</span></code></p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_5.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_5.svg" class="scale-to-fit" src="_images/parallel_region_to_orthogonal_component_mapping_5.svg" /></a>
<p>We will use meta events to pass messages in and out of orthogonal components.
As you walk through the code, remember that <code class="docutils literal notranslate"><span class="pre">_post_fifo</span></code> and <code class="docutils literal notranslate"><span class="pre">_post_lifo</span></code>
only place events into the queues of all of the regions connected to those
calls.  <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> and <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> place events <em>and</em> drives those events
through their connected orthogonal components.</p>
<p>If we started the above chart in the outer_state and sent it an <code class="docutils literal notranslate"><span class="pre">E0</span></code> we would
end up in the <code class="docutils literal notranslate"><span class="pre">[['p_p11_s12',</span> <span class="pre">'...'],</span> <span class="pre">['...']]</span></code> states.</p>
<p>The code that makes the programmable init work isn’t on the diagram, but it
looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
  <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
  <span class="c1"># if _state is a child of this state then transition to it</span>
  <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">_state</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11</span><span class="p">)</span>  <span class="c1"># the default state to transition to</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">rr</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As I continued on the project, I extended the trouble shooting code included
with the miros python libray.  To have a meta-event trace appear in your logs,
look for the definition of <code class="docutils literal notranslate"><span class="pre">events_to_investigate</span></code> at the top of your
experiment file and assign the signal name of the meta event you want to
investigate:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">events_to_investigate</span> <span class="o">=</span> <span class="s1">&#39;E1&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="a-walk-through-of-a-wtf-transition-case-2">
<h2>A Walk through of a WTF Transition, Case 2<a class="headerlink" href="#a-walk-through-of-a-wtf-transition-case-2" title="Permalink to this headline">#</a></h2>
<p>Let’s focus on something a bit more difficult, the <code class="docutils literal notranslate"><span class="pre">G1</span></code> WTF event (click to
enlarge):</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_6.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_6.svg" class="scale-to-fit" src="_images/parallel_region_to_orthogonal_component_mapping_6.svg" /></a>
<p>From the top Harel diagram, we see that if the system is in <code class="docutils literal notranslate"><span class="pre">p_p11_s12</span></code> and we
receive a <code class="docutils literal notranslate"><span class="pre">G1</span></code> we should transition into <code class="docutils literal notranslate"><span class="pre">p_s22</span></code>.  But what happens to
region 1 of <code class="docutils literal notranslate"><span class="pre">p</span></code>?  Well, we want it to be non-reactive, unless it is
explicitely reactivated by <code class="docutils literal notranslate"><span class="pre">to_p</span></code>.</p>
<p>To summarize:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[[</span><span class="s1">&#39;p_p11_s12&#39;</span>, <span class="s1">&#39;p_p11_s21&#39;</span><span class="o">]</span>, <span class="s1">&#39;p_s21&#39;</span><span class="o">]</span> &lt;- G1 <span class="se">\</span>
  <span class="o">==</span> <span class="o">[</span><span class="s1">&#39;p_r1_under_hidden_region&#39;</span>, <span class="s1">&#39;p_s22&#39;</span><span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="a-walk-through-of-a-wtf-transition-case-3">
<h2>A Walk through of a WTF Transition, Case 3<a class="headerlink" href="#a-walk-through-of-a-wtf-transition-case-3" title="Permalink to this headline">#</a></h2>
<p>Let’s focus on something a bit less difficult, the <code class="docutils literal notranslate"><span class="pre">G0</span></code> WTF event (click to
enlarge):</p>
<a class="reference external image-reference" href="_static/parallel_region_to_orthogonal_component_mapping_7.pdf"><img alt="_images/parallel_region_to_orthogonal_component_mapping_7.svg" class="scale-to-fit" src="_images/parallel_region_to_orthogonal_component_mapping_7.svg" /></a>
<p>From the top Harel diagram, we see that if the system is in <code class="docutils literal notranslate"><span class="pre">p_p22</span></code> and we
receive a <code class="docutils literal notranslate"><span class="pre">G0</span></code> we should transition into <code class="docutils literal notranslate"><span class="pre">p_p11_s12</span></code>.  Like the previous
example we want a region to become non-reactive, but in this case it’s region 2
of <code class="docutils literal notranslate"><span class="pre">p</span></code>.</p>
<p>To summarize:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[[</span><span class="s1">&#39;p_p11_s12&#39;</span>, <span class="s1">&#39;p_p11_s21&#39;</span><span class="o">]</span>, <span class="s1">&#39;p_s21&#39;</span><span class="o">]</span> &lt;- G1 <span class="se">\</span>
  <span class="o">==</span> <span class="o">[[</span><span class="s1">&#39;p_p11_s12&#39;</span>, <span class="s1">&#39;p_p11_s21&#39;</span><span class="o">]</span>, <span class="s1">&#39;p_r2_under_hidden_region&#39;</span><span class="o">]</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-a-systematic-way-of-naming-wtf-events">
<span id="how-it-works-creating-a-systematic-way-of-naming-wtf-events"></span><h2>Creating a Systematic way of Naming WTF Events<a class="headerlink" href="#creating-a-systematic-way-of-naming-wtf-events" title="Permalink to this headline">#</a></h2>
<p>This library will support events which transition across regional and parallel
boundaries.  To do this I need to figure out how to build a small testing
diagram from which I can test every supported transition type.  This testing
diagram will serve as the specification for the parallel region feature of this
library.</p>
<p>To begin this theoretical work lets start by examining the topological diagrams
taken from figure 4.6 on page 178 of Practical UML Statecharts in C/C++, Second
Addition.  Here, Miro Samek demonstrates what family of graphs are supported by
his event processor (then does a code walk through about how each graph is
supported).</p>
<div class="figure align-default" id="id3">
<a class="reference external image-reference" href="_static/xml_chart_5_guidance_graphs.pdf"><img alt="_images/xml_chart_5_guidance_graphs.svg" class="noscale-center" src="_images/xml_chart_5_guidance_graphs.svg" /></a>
<p class="caption"><span class="caption-text">From page 178 of Practical UML Statecharts in C/C++, Second Addition</span><a class="headerlink" href="#id3" title="Permalink to this image">#</a></p>
</div>
<p>Here is a coloured and named list of transition classes which are being added by
this library to provide the “parallel regions” feature:</p>
<a class="reference external image-reference" href="_static/xml_chart_5_guidance_naming.pdf"><img alt="_images/xml_chart_5_guidance_naming.svg" class="noscale-center" src="_images/xml_chart_5_guidance_naming.svg" /></a>
<p>To create a test pattern, I need to consider all combinations of the transition
types with the topological sub-graphs.</p>
<a class="reference external image-reference" href="_static/xml_chart_5_guidance.pdf"><img alt="_images/xml_chart_5_guidance.svg" class="scale-to-fit" src="_images/xml_chart_5_guidance.svg" /></a>
<p>Not all transitions make sense, and the transitions mapped onto a nominal
statechart have already been verified; so instead of having to test 32 possible
topologies, we only have to map (at a minimum) 17 types of transitions.</p>
<p>These 17 types of transitions are mapped onto the following test
pattern:</p>
<a class="reference external image-reference" href="_static/xml_chart_5.pdf"><img alt="_images/xml_chart_5.svg" class="scale-to-fit" src="_images/xml_chart_5.svg" /></a>
<p>Note that there are more than 17 different events being tested.  Some of the
events are there to conveniently transition from test to test and others are
there for testing the edge conditions of the design.</p>
<p>An event is named like this:</p>
<p><code class="docutils literal notranslate"><span class="pre">&lt;transition-type</span> <span class="pre">topology-type</span> <span class="pre">number&gt;</span></code></p>
<p>For example, PC1, is testing a parallel transition of the PC topology type.  PC1
is the first event that is testing this type of transition, so it is post-pended
with the number 1.</p>
<p>The test pattern is a good first step for figuring out what has to be tested to
build a robust feature.  At any time in the future, I can add more events (like
the red hooks).  If you are reading this and see a major bug in my theory, email
me and let me know.</p>
</div>
<div class="section" id="beastiary">
<span id="how-it-works-beastiary"></span><h2>Beastiary<a class="headerlink" href="#beastiary" title="Permalink to this headline">#</a></h2>
<a class="reference external image-reference" href="_static/xml_chart_5.pdf"><img alt="_images/xml_chart_5.svg" class="scale-to-fit" src="_images/xml_chart_5.svg" /></a>
<table class="colwidths-given docutils align-left">
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Transition Type</p></th>
<th class="head"><p>Name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>R: Transitions within inner orthogonal regions</p></td>
<td><p><a class="reference internal" href="#ra1"><span class="std std-ref">RA1</span></a>
<a class="reference internal" href="#ra2"><span class="std std-ref">RA2</span></a>
<a class="reference internal" href="#rb1"><span class="std std-ref">RB1</span></a>
<a class="reference internal" href="#rc1"><span class="std std-ref">RC1</span></a>
<a class="reference internal" href="#rc2"><span class="std std-ref">RC2</span></a>
<a class="reference internal" href="#rd1"><span class="std std-ref">RD1</span></a>
<a class="reference internal" href="#re1"><span class="std std-ref">RE1</span></a>
<a class="reference internal" href="#rf1"><span class="std std-ref">RF1</span></a>
<a class="reference internal" href="#rg1"><span class="std std-ref">RG1</span></a>
<a class="reference internal" href="#rh1"><span class="std std-ref">RH1</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>SR: Transitions between the bounds of the orthogonal region and outer statechart</p></td>
<td><p><a class="reference internal" href="#srb1"><span class="std std-ref">SRB1</span></a>
<a class="reference internal" href="#srd1"><span class="std std-ref">SRD1</span></a>
<a class="reference internal" href="#srd2"><span class="std std-ref">SRD2</span></a>
<a class="reference internal" href="#sre1"><span class="std std-ref">SRE1</span></a>
<a class="reference internal" href="#sre2"><span class="std std-ref">SRE2</span></a>
<a class="reference internal" href="#sre3"><span class="std std-ref">SRE3</span></a>
<a class="reference internal" href="#srf1"><span class="std std-ref">SRF1</span></a>
<a class="reference internal" href="#srg1"><span class="std std-ref">SRG1</span></a></p></td>
</tr>
<tr class="row-even"><td><p>P: Transitions across parallel regions</p></td>
<td><p><a class="reference internal" href="#pc1"><span class="std std-ref">PC1</span></a>
<a class="reference internal" href="#pf1"><span class="std std-ref">PF1</span></a>
<a class="reference internal" href="#pg1"><span class="std std-ref">PG1</span></a>
<a class="reference internal" href="#pg2"><span class="std std-ref">PG2</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>H: Hooks and transitions</p></td>
<td><p><a class="reference internal" href="#h1"><span class="std std-ref">H1</span></a>
<a class="reference internal" href="#h2"><span class="std std-ref">H2</span></a></p></td>
</tr>
<tr class="row-even"><td><p>S: Standard Transitions</p></td>
<td><p><a class="reference internal" href="#sa1"><span class="std std-ref">SA1</span></a>
<a class="reference internal" href="#sb1"><span class="std std-ref">SB1</span></a>
<a class="reference internal" href="#sc1"><span class="std std-ref">SC1</span></a>
<a class="reference internal" href="#sd1"><span class="std std-ref">SD1</span></a>
<a class="reference internal" href="#sh1"><span class="std std-ref">SH1</span></a>
<a class="reference internal" href="#sh2"><span class="std std-ref">SH2</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>final: An SCXML addon.  When all regions of a state transition to their final pseudostate, create then post an artificial event with the signal name equal to the outer state holding the regions, with the string “_final” post pended to the signal’s name.</p></td>
<td><p><a class="reference internal" href="#p-p11-final"><span class="std std-ref">p_p11_final</span></a>
<a class="reference internal" href="#p-p12-final"><span class="std std-ref">p_p12_final</span></a>
<a class="reference internal" href="#p-p22-final"><span class="std std-ref">p_p22_final</span></a></p></td>
</tr>
</tbody>
</table>
<table class="colwidths-given docutils align-left">
<colgroup>
<col style="width: 8%" />
<col style="width: 23%" />
<col style="width: 23%" />
<col style="width: 38%" />
<col style="width: 9%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Event Name</p></th>
<th class="head"><p>Where to look</p></th>
<th class="head"><p>Transition Type</p></th>
<th class="head"><p>Topological Type or Notes</p></th>
<th class="head"><p>✓/✗</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RA1</p></td>
<td><p>p_p11 to p_p11</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/a_t.pdf"><img alt="_images/a_t.svg" class="noscale-center" src="_images/a_t.svg" /></a>
</td>
<td><p id="ra1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>RA2</p></td>
<td><p>p_p12 to p_p12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/a_t.pdf"><img alt="_images/a_t.svg" class="noscale-center" src="_images/a_t.svg" /></a>
</td>
<td><p id="ra2">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>RB1</p></td>
<td><p>p_p12 to p_p12_p11</p></td>
<td><p>R</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/b_t.pdf"><img alt="_images/b_t.svg" class="noscale-center" src="_images/b_t.svg" /></a>
</td>
<td><p id="rb1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>RC1</p></td>
<td><p>p_p11 to p_p12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/c_t.pdf"><img alt="_images/c_t.svg" class="noscale-center" src="_images/c_t.svg" /></a>
</td>
<td><p id="rc1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>RC2</p></td>
<td><p>p_p22 to p_s21</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/c_t.pdf"><img alt="_images/c_t.svg" class="noscale-center" src="_images/c_t.svg" /></a>
</td>
<td><p id="rc2">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>RD1</p></td>
<td><p>p_p12_p11 to p_p12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/d_t.pdf"><img alt="_images/d_t.svg" class="noscale-center" src="_images/d_t.svg" /></a>
</td>
<td><p id="rd1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>RE1</p></td>
<td><p>p_p12 to p_p12_p11_s12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/e_t.pdf"><img alt="_images/e_t.svg" class="noscale-center" src="_images/e_t.svg" /></a>
</td>
<td><p id="re1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>RF1</p></td>
<td><p>p_p11 to p_p12_p11_p12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/f_t.pdf"><img alt="_images/f_t.svg" class="noscale-center" src="_images/f_t.svg" /></a>
</td>
<td><p id="rf1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>RG1</p></td>
<td><p>p_p12_p11_s21 to p_p11_s12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/g_t.pdf"><img alt="_images/g_t.svg" class="noscale-center" src="_images/g_t.svg" /></a>
</td>
<td><p id="rg1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>RH1</p></td>
<td><p>p_p12_p11_s12 to p_p12</p></td>
<td><p>R: transitions within inner orthogonal regions</p>
<a class="reference external image-reference" href="_static/r_transition_class.pdf"><img alt="_images/r_transition_class.svg" class="noscale-center" src="_images/r_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="rh1">✓</p>
</td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>SRB1</p></td>
<td><p>p to p_p22</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/b_t.pdf"><img alt="_images/b_t.svg" class="noscale-center" src="_images/b_t.svg" /></a>
</td>
<td><p id="srb1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SRD1</p></td>
<td><p>p_p22 to p</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/d_t.pdf"><img alt="_images/d_t.svg" class="noscale-center" src="_images/d_t.svg" /></a>
</td>
<td><p id="srd1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SRD2</p></td>
<td><p>p_s21 to p</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/d_t.pdf"><img alt="_images/d_t.svg" class="noscale-center" src="_images/d_t.svg" /></a>
</td>
<td><p id="srd2">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SRE1</p></td>
<td><p>middle to p_p11</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/e_t.pdf"><img alt="_images/e_t.svg" class="noscale-center" src="_images/e_t.svg" /></a>
</td>
<td><p id="sre1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SRE2</p></td>
<td><p>p to p_p11_s12</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/e_t.pdf"><img alt="_images/e_t.svg" class="noscale-center" src="_images/e_t.svg" /></a>
</td>
<td><p id="sre2">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SRE3</p></td>
<td><p>outer to p_p22_s22</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/e_t.pdf"><img alt="_images/e_t.svg" class="noscale-center" src="_images/e_t.svg" /></a>
</td>
<td><p id="sre3">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SRF1</p></td>
<td><p>s to p_p22_s21</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/f_t.pdf"><img alt="_images/f_t.svg" class="noscale-center" src="_images/f_t.svg" /></a>
</td>
<td><p id="srf1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SRG1</p></td>
<td><p>p_p22_s21 to s_s1</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/g_t.pdf"><img alt="_images/g_t.svg" class="noscale-center" src="_images/g_t.svg" /></a>
</td>
<td><p id="srg1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SRH1</p></td>
<td><p>p_s21 to outer</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="srh1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SRH2</p></td>
<td><p>p_p11 to middle</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="srh2">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SRH3</p></td>
<td><p>p_p11_s12 to p</p></td>
<td><p>SR: Transition between the bounds of the orthogonal region and outer statechart</p>
<a class="reference external image-reference" href="_static/sr_transition_class.pdf"><img alt="_images/sr_transition_class.svg" class="noscale-center" src="_images/sr_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="srh3">✓</p>
</td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>PC1</p></td>
<td><p>p_p11 to p_s21</p></td>
<td><p>P: Transitions across parallel regions</p>
<a class="reference external image-reference" href="_static/p_transition_class.pdf"><img alt="_images/p_transition_class.svg" class="noscale-center" src="_images/p_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/c_t.pdf"><img alt="_images/c_t.svg" class="noscale-center" src="_images/c_t.svg" /></a>
</td>
<td><p id="pc1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>PF1</p></td>
<td><p>p_s21 to p_p12_p11_s21</p></td>
<td><p>P: Transitions across parallel regions</p>
<a class="reference external image-reference" href="_static/p_transition_class.pdf"><img alt="_images/p_transition_class.svg" class="noscale-center" src="_images/p_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/f_t.pdf"><img alt="_images/f_t.svg" class="noscale-center" src="_images/f_t.svg" /></a>
</td>
<td><p id="pf1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>PG1</p></td>
<td><p>p_p12_p11_s21 to p_p22_s11</p></td>
<td><p>P: Transitions across parallel regions</p>
<a class="reference external image-reference" href="_static/p_transition_class.pdf"><img alt="_images/p_transition_class.svg" class="noscale-center" src="_images/p_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/g_t.pdf"><img alt="_images/g_t.svg" class="noscale-center" src="_images/g_t.svg" /></a>
</td>
<td><p id="pg1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>PG2</p></td>
<td><p>p_p11_s22 to p_s21</p></td>
<td><p>P: Transitions across parallel regions</p>
<a class="reference external image-reference" href="_static/p_transition_class.pdf"><img alt="_images/p_transition_class.svg" class="noscale-center" src="_images/p_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/g_t.pdf"><img alt="_images/g_t.svg" class="noscale-center" src="_images/g_t.svg" /></a>
</td>
<td><p id="pg2">✓</p>
</td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>H1</p></td>
<td><p>p to middle, p_p12, p_p11, p_p12_s21</p></td>
<td><p>hook</p></td>
<td><p>hook</p></td>
<td><p id="h1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>H2</p></td>
<td><p>p_p22_s11</p></td>
<td><p>hook</p></td>
<td><p>hook</p></td>
<td><p id="h2">✓</p>
</td>
</tr>
<tr class="row-even"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>SA1</p></td>
<td><p>middle to p</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/a_t.pdf"><img alt="_images/a_t.svg" class="noscale-center" src="_images/a_t.svg" /></a>
</td>
<td><p id="sa1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SB1</p></td>
<td><p>middle to p</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/b_t.pdf"><img alt="_images/b_t.svg" class="noscale-center" src="_images/b_t.svg" /></a>
</td>
<td><p id="sb1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SC1</p></td>
<td><p>p to s</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/c_t.pdf"><img alt="_images/c_t.svg" class="noscale-center" src="_images/c_t.svg" /></a>
</td>
<td><p id="sc1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SD1</p></td>
<td><p>p to middle</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/d_t.pdf"><img alt="_images/d_t.svg" class="noscale-center" src="_images/d_t.svg" /></a>
</td>
<td><p id="sd1">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>SH1</p></td>
<td><p>outer to p</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="sh1">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>SH2</p></td>
<td><p>outer to middle</p></td>
<td><p>S: Standard transition</p>
<a class="reference external image-reference" href="_static/s_transition_class.pdf"><img alt="_images/s_transition_class.svg" class="noscale-center" src="_images/s_transition_class.svg" /></a>
</td>
<td><a class="reference external image-reference" href="_static/h_t.pdf"><img alt="_images/h_t.svg" class="noscale-center" src="_images/h_t.svg" /></a>
</td>
<td><p id="sh2">✓</p>
</td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>p_p11_final</p></td>
<td><p>p_p11 to p_p12</p></td>
<td><p>final: SCXML addon</p></td>
<td><p>Any topology</p></td>
<td><p id="p-p11-final">✓</p>
</td>
</tr>
<tr class="row-odd"><td><p>p_p12_final</p></td>
<td><p>p_p12 to final pseudostate inside of r1 of p</p></td>
<td><p>final: SCXML addon</p></td>
<td><p>Any topology</p></td>
<td><p id="p-p12-final">✓</p>
</td>
</tr>
<tr class="row-even"><td><p>p_p22_final</p></td>
<td><p>p_p22 to final pseudostate inside of r2 of p</p></td>
<td><p>final: SCXML addon</p></td>
<td><p>Any topology</p></td>
<td><p id="p-p22-final">✓</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="construction-tactics">
<span id="how-it-works-construction-strategy"></span><h2>Construction Tactics<a class="headerlink" href="#construction-tactics" title="Permalink to this headline">#</a></h2>
<p>To provide the parallel region feature, miros-xml writes a bunch of miros statechart
code for you.  The concurrent parallel states behavior is mimicked by linking a bunch of
orthogonal regions together with hidden states and special handling of recursively
structured events.  This section describes how these features were constructed.</p>
<p>This package uses a set of naming conventions when trying to decide what to call
hidden states, regions, and final signals.  In this way it takes a “convention
over configuration” approach.  The convention emerged from wrestling with the
problem, and on the most part it should be hidden from view.
Nonetheless, this convention is described in this section so that I can write
them down as they are invented.</p>
<div class="contents local topic" id="id2">
<ul class="simple">
<li><p><a class="reference internal" href="#experimental-files" id="id37">Experimental Files</a></p></li>
<li><p><a class="reference internal" href="#naming-conventions" id="id38">Naming Conventions</a></p></li>
<li><p><a class="reference internal" href="#automatic-construction-of-hidden-states" id="id39">Automatic Construction of Hidden States</a></p></li>
<li><p><a class="reference internal" href="#automatic-construction-of-injectors" id="id40">Automatic Construction of Injectors</a></p></li>
</ul>
</div>
<div class="section" id="experimental-files">
<span id="how-it-works-experimental-files"></span><h3>Experimental Files<a class="headerlink" href="#experimental-files" title="Permalink to this headline">#</a></h3>
<p>The parallel region feature is being built out using four files:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/experiment/logger_config.yaml</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/experiment/xml_chart_5.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/experiment/augment.py</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/experiment/xml_chart_5.2.py</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">logger_config.yml</span></code> contains logging specifications.  It is very difficult to
trace a recursive WTF event as it is being passed between various orthogonal
states.  Logging drops the instrumentation records, what was done by which part
of the program into files that can be inspected in great detail.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">xml_chart_5.py</span></code> file is flat in its architecture.  All of the state functions
are written out by hand, so a lot of the code is copied and pasted.  The
xml_chart_5.py was the program used to build up the hidden state features and
meta event handling.  It has been left in this flat state to make it easy to
debug WTF event logic.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">augment.py</span></code> was used to demonstrate <a class="reference internal" href="techniques.html#techniques-adding-and-removing-behavior-from-functions"><span class="std std-ref">advanced-partial-function
techniques</span></a>
like, asking a partial to add or removed behavior from itself, and return a new
working function that can be added to a statemachine.  These partial functions
can also be called in such a way that they will describe what they do.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">xml_chart_5.2.py</span></code> file uses the techniques of augment.py to squish
the longer functions of xml_chart_5.py into a collection of smaller templates.</p>
<p>The regression tests for these programs are written within them, so a program can
just be run to see if it is working.  While working on a program I watch for
file modifications, then run the program to test itself:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">inotify</span><span class="o">-</span><span class="n">tools</span>  <span class="c1"># install a file-watcher</span>

<span class="c1"># use the file-watcher to re-run a test when it detects changes to a file</span>
<span class="k">while</span> <span class="n">inotifywait</span> <span class="o">-</span><span class="n">e</span> <span class="n">modify</span> <span class="n">xml_chart_5</span><span class="o">.</span><span class="mf">2.</span><span class="n">py</span> <span class="n">logger_config</span><span class="o">.</span><span class="n">yaml</span><span class="p">;</span>\
  <span class="n">do</span> <span class="n">python</span> <span class="n">xml_chart_5</span><span class="o">.</span><span class="mf">2.</span><span class="n">py</span><span class="p">;</span> <span class="n">done</span>
</pre></div>
</div>
</div>
<div class="section" id="naming-conventions">
<span id="how-it-works-naming-conventions"></span><h3>Naming Conventions<a class="headerlink" href="#naming-conventions" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section applies to <code class="docutils literal notranslate"><span class="pre">xml_chart_5.py</span></code>, <code class="docutils literal notranslate"><span class="pre">logger_config.yaml</span></code> and <code class="docutils literal notranslate"><span class="pre">xml_chart_5.2.py</span></code>.</p>
</div>
<p>Rules:</p>
<blockquote>
<div><ul class="simple">
<li><p>An injector function and its region have the same name</p></li>
<li><p>final signal name: ‘&lt;regions_name&gt;_final’</p></li>
<li><p>WTF meta event names: <cite>&lt;purpose&gt;_META_SIGNAL</cite>, where purpose is <code class="docutils literal notranslate"><span class="pre">INIT</span></code>,
<code class="docutils literal notranslate"><span class="pre">EXIT</span></code>, <code class="docutils literal notranslate"><span class="pre">BOUNCE_SAME</span></code>, <code class="docutils literal notranslate"><span class="pre">BOUNCE_ACROSS</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">OUTER_TRANS_REQUIRED</span></code></p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="automatic-construction-of-hidden-states">
<span id="how-it-works-automatic-construction-of-hidden-states"></span><h3>Automatic Construction of Hidden States<a class="headerlink" href="#automatic-construction-of-hidden-states" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section applies to <code class="docutils literal notranslate"><span class="pre">xml_chart_5.2.py</span></code></p>
</div>
<p>The miros-xml package <a class="reference internal" href="#how-it-works-hidden-states-and-what-they-are-for"><span class="std std-ref">adds four hidden functions</span></a> (grey in the diagram) for
each orthogonal state:</p>
<a class="reference external image-reference" href="_static/hidden_states_1.pdf"><img alt="_images/hidden_states_1.svg" class="noscale-center" src="_images/hidden_states_1.svg" /></a>
<p><strong>Goal</strong>: We want the <code class="docutils literal notranslate"><span class="pre">add</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Regions</span></code> object to create the grayed
out functions for us, using a predetermined naming convention.</p>
<p>We will use the module_namespace to attach and get functions based on a string,
using the Python <code class="docutils literal notranslate"><span class="pre">setattr/getattr</span></code> builtins.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">module_namespace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span>

<span class="c1"># these are the same</span>
<span class="n">module_namespace</span><span class="o">.</span><span class="n">p_r1_under_hidden_region</span><span class="p">()</span>
<span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="s1">&#39;p_r1_under_hidden_region&#39;</span><span class="p">)()</span>
</pre></div>
</div>
<p>Before we make something that writes functions, we will type one out by hand,
pass a full regression test, then identify the parts of the function we want to
change:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@othogonal_state</span>
<span class="hll"><span class="k">def</span> <span class="nf">p_r1_under_hidden_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
</span>  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">__super__</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">bottom</span>

  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_r1_region</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>Things that need to change in the above function:</p>
<ul class="simple">
<li><p>it needs a unique name (line 1)</p></li>
<li><p>it will reference the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> function, line 12.</p></li>
</ul>
<p>Now we write a template, knowing that we will rename it later.  We use the
<code class="docutils literal notranslate"><span class="pre">*</span></code>, character to separate the non-mandatorily-named arguments from the ones
that require a name; <code class="docutils literal notranslate"><span class="pre">region_state_name</span></code>.  We also add the <code class="docutils literal notranslate"><span class="pre">**kwargs</span></code> as a
place holder for named arguments this function will not use.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">template_under_hidden_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">region_state_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;some docstring&#39;&#39;&#39;</span>

  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">__super__</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">bottom</span>

<span class="hll">  <span class="n">region_state_function</span> <span class="o">=</span> \
</span><span class="hll">    <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">region_state_name</span><span class="p">)</span>
</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>

  <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">region_state_function</span><span class="p">)</span>
</span>  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</td></tr></table></div>
<p>Notice on lines 7-8, we use <code class="docutils literal notranslate"><span class="pre">getattr(module_namespace,</span> <span class="pre">region_state_name)</span></code> to
get the region function.  This function is used on line 16.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">region_state_name</span></code> was set to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code>, our function would behave
the same as the one we wrote out by hand.  Notice, that the template does not
have an <code class="docutils literal notranslate"><span class="pre">orthogonal</span></code> decorator, but our handwritten function does. This
decorator will be added later.</p>
<p>Now we want to create a new function based on some naming conventions:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>

<span class="c1"># functions at the top of the file</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">under_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_under_hidden_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">over_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_over_hidden_region&quot;</span>

<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">final_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">region_name</span> <span class="o">+</span> <span class="s2">&quot;_final&quot;</span>

<span class="c1"># ..</span>

<span class="c1"># in the Regions class:</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_name</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">outer</span><span class="p">):</span>
  <span class="c1"># ...</span>
  <span class="n">region_name</span> <span class="o">=</span> <span class="s2">&quot;p_r1&quot;</span>  <span class="c1"># force the region_name for our example</span>
  <span class="n">under_s</span> <span class="o">=</span> <span class="n">under_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">region_s</span> <span class="o">=</span> <span class="n">region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">over_s</span> <span class="o">=</span> <span class="n">over_hidden_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>
  <span class="n">final_s</span> <span class="o">=</span> <span class="n">final_region_function_name</span><span class="p">(</span><span class="n">region_name</span><span class="p">)</span>

  <span class="c1"># The &#39;template_under_hidden_region&#39; is defined in documentation above,</span>
  <span class="c1"># the other templates would be defined in similar manner</span>
<span class="hll">  <span class="k">for</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">template</span> <span class="ow">in</span> <span class="p">[</span>
</span><span class="hll">    <span class="p">(</span><span class="n">under_s</span><span class="p">,</span> <span class="n">template_under_hidden_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">region_s</span><span class="p">,</span> <span class="n">template_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">over_s</span><span class="p">,</span> <span class="n">template_over_hidden_region</span><span class="p">),</span>
</span><span class="hll">    <span class="p">(</span><span class="n">final_s</span><span class="p">,</span> <span class="n">template_final</span><span class="p">)</span>
</span><span class="hll">  <span class="p">]:</span>
</span>
    <span class="c1"># The &#39;template&#39; and &#39;region_state_name&#39; are used in the</span>
    <span class="c1"># &#39;template_under_hidden_region&#39;, but the other named arguments are</span>
    <span class="c1"># placed into its kwargs argument and ignored by the function.  These</span>
    <span class="c1"># extra named arguments are needed by one or more of the other template</span>
    <span class="c1"># functions.</span>
<span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span class="hll">      <span class="n">template</span><span class="p">,</span>
</span><span class="hll">      <span class="n">this_function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
</span><span class="hll">      <span class="n">under_region_state_name</span><span class="o">=</span><span class="n">under_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">region_state_name</span><span class="o">=</span><span class="n">region_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">over_region_state_name</span><span class="o">=</span><span class="n">over_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">final_state_name</span><span class="o">=</span><span class="n">final_s</span><span class="p">,</span>
</span><span class="hll">      <span class="n">initial_state_name</span><span class="o">=</span><span class="n">initial_state</span>
</span><span class="hll">    <span class="p">)</span>
</span>
<span class="hll">    <span class="c1"># give the fn the meta data defined by its template</span>
</span><span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">update_wrapper</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># over-write the function name</span>
</span><span class="hll">    <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">function_name</span>
</span><span class="hll">    <span class="c1"># wrap the function with an instrumentation decorator</span>
</span><span class="hll">    <span class="n">fn</span> <span class="o">=</span> <span class="n">orthogonal_state</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># over-write the instrumented function with its name</span>
</span><span class="hll">    <span class="n">fn</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">function_name</span>
</span><span class="hll">    <span class="c1"># place the new function in this module&#39;s namespace</span>
</span><span class="hll">    <span class="nb">setattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
</span>
  <span class="c1"># Here we get the functions from the name space using our function names as</span>
  <span class="c1"># strings.</span>
<span class="hll">  <span class="n">region_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">region_s</span><span class="p">)</span>
</span><span class="hll">  <span class="n">over_hidden_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">over_s</span><span class="p">)</span>
</span><span class="hll">  <span class="n">under_hidden_state_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_namespace</span><span class="p">,</span> <span class="n">under_s</span><span class="p">)</span>
</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">p_r1_under_hidden_region</span><span class="p">))</span>    <span class="c1"># can call what was created</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">under_hidden_state_function</span><span class="p">))</span> <span class="c1"># can call indirectly too</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">region_function_name</span><span class="p">))</span>
  <span class="k">assert</span><span class="p">(</span><span class="n">callable</span><span class="p">(</span><span class="n">over_hidden_state_function</span><span class="p">))</span>

  <span class="c1"># ... construct the regions</span>
</pre></div>
</td></tr></table></div>
<p>The above code listing shows how all of our hidden functions would be made from
a set of templates, an initial_state target and some function names built by a
convention using the region name.</p>
<p>Lines 35-40 show how we specify a template-naming partnership.</p>
<p>Lines 47-55 shows how a new function is built from the template.</p>
<p>Lines 57-66 name our new function, wrap it with an instrumentation decorator,
name this wrapped function, then attach it to the modules namespace.</p>
<p>Lines 70-72 show how to get a function using its name.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you have done work like this, never use the eval(function_name_as_string)
to get access to the function.  This will destroy the function’s <code class="docutils literal notranslate"><span class="pre">__name__</span></code> and
<code class="docutils literal notranslate"><span class="pre">__doc__</span></code> values and cause your tests to fail.</p>
</div>
</div>
<div class="section" id="automatic-construction-of-injectors">
<span id="how-it-works-automatic-construction-of-injectors"></span><h3>Automatic Construction of Injectors<a class="headerlink" href="#automatic-construction-of-injectors" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section applies to <code class="docutils literal notranslate"><span class="pre">xml_chart_5.2.py</span></code></p>
</div>
<p>State functions have Regions objects which have Region objects which have state
functions.</p>
<p>A parallel region can exist inside of any state function.  In this architecture, the
parallel regions feature is contained within a regions object.  If the regions
object exists within a state, that state is called an injector.  An injector has
the same name as the regions object it controls.</p>
<a class="reference external image-reference" href="_static/regions_in_regions.pdf"><img alt="_images/regions_in_regions.svg" class="noscale-center" src="_images/regions_in_regions.svg" /></a>
<p>An injector is structured like any state function, it consists of a large
if-elif-else structure that helps the event processor make sense of the HSM’s
graph.  To make an injector handle the meta-events, or the events that give the
illusion of a parallel region, it contains special handling for
<code class="docutils literal notranslate"><span class="pre">INIT_META_SIGNAL</span></code>, <code class="docutils literal notranslate"><span class="pre">EXIT_META_SIGNAL</span></code> and so on.</p>
<p>Here is an example of an injector from <code class="docutils literal notranslate"><span class="pre">xml_chart_5.py</span></code>, with the code common to
all injectors highlighted.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@othogonal_state</span>
</span><span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="hll">  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
</span>  <span class="n">__super__</span> <span class="o">=</span> <span class="n">p_r1_over_hidden_region</span>
  <span class="n">__hooks__</span> <span class="o">=</span> <span class="p">[</span><span class="n">signals</span><span class="o">.</span><span class="n">H1</span><span class="p">]</span>

<span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
</span><span class="hll">    <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">SEARCH_FOR_META_HOOKS</span><span class="p">):</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">signal</span> <span class="ow">in</span> <span class="n">__hooks__</span><span class="p">:</span>
</span><span class="hll">      <span class="k">return</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>
<span class="hll">  <span class="c1"># enter all regions</span>
</span><span class="hll">  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">rsm</span><span class="p">(</span><span class="n">p_p11</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># search for INIT_META_SIGNAL</span>
</span><span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_peel</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">investigate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
</span><span class="hll">      <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">rsm</span><span class="p">(</span><span class="n">p_p11</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span>  <span class="c1"># any event handled within there regions must be pushed from here</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;SRH3&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;PG2&quot;</span><span class="p">)</span>
       <span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;H1&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="s2">&quot;p_p11 hooked&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p12</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;RC1&quot;</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_trans</span><span class="p">(</span>
      <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
      <span class="n">s</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
      <span class="n">t</span><span class="o">=</span><span class="n">p_p12</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;SRH2&quot;</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_trans</span><span class="p">(</span>
      <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
      <span class="n">s</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
      <span class="n">t</span><span class="o">=</span><span class="n">middle</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;RA1&quot;</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_trans</span><span class="p">(</span>
      <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
      <span class="n">s</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
      <span class="n">t</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;PF1&quot;</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span> <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;PC1&quot;</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_trans</span><span class="p">(</span>
      <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
      <span class="n">s</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
      <span class="n">t</span><span class="o">=</span><span class="n">p_s21</span><span class="p">,</span>
    <span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;RF1&quot;</span><span class="p">)):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">meta_trans</span><span class="p">(</span>
      <span class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
      <span class="n">s</span><span class="o">=</span><span class="n">p_p11</span><span class="p">,</span>
      <span class="n">t</span><span class="o">=</span><span class="n">p_p12_p11_s12</span><span class="p">,</span>
    <span class="p">)</span>
<span class="hll">  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BOUNCE_SAME_META_SIGNAL</span><span class="p">:</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">_state</span><span class="p">,</span> <span class="n">_e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">investigate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">))</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">OUTER_TRANS_REQUIRED</span><span class="p">:</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span>
</span><span class="hll">    <span class="n">investigate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">_state</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">state_fn</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
</span><span class="hll">      <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">exit_region</span><span class="p">))</span>
</span><span class="hll">      <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
</span><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span><span class="hll">      <span class="k">if</span> <span class="n">within</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">state_fn</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
</span><span class="hll">        <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
</span><span class="hll">  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_META_SIGNAL</span><span class="p">:</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span>
</span><span class="hll">    <span class="n">investigate</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="c1"># this appears backwards, but it needs to be this way.</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">within</span><span class="p">(</span><span class="n">_state</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">state_fn</span><span class="p">):</span>
</span><span class="hll">      <span class="c1"># The next state is going to be our region handler skip it and post this</span>
</span><span class="hll">      <span class="c1"># region handler would have posted to the outer HSM</span>
</span><span class="hll">      <span class="k">if</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_META_SIGNAL</span> <span class="ow">or</span>
</span><span class="hll">         <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BOUNCE_ACROSS_META_SIGNAL</span> <span class="ow">or</span>
</span><span class="hll">         <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">OUTER_TRANS_REQUIRED</span>
</span><span class="hll">         <span class="p">):</span>
</span><span class="hll">        <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span>
</span><span class="hll">        <span class="n">r</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">      <span class="k">elif</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">BOUNCE_ACROSS_META_SIGNAL</span> <span class="ow">or</span>
</span><span class="hll">           <span class="n">_e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_META_SIGNAL</span><span class="p">):</span>
</span><span class="hll">        <span class="n">r</span><span class="o">.</span><span class="n">outer</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">      <span class="k">else</span><span class="p">:</span>
</span><span class="hll">        <span class="n">r</span><span class="o">.</span><span class="n">same</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">exit_region</span><span class="p">:</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">_p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_r1_under_hidden_region</span><span class="p">)</span>
</span><span class="hll">  <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span><span class="p">:</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">inner</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">exit_region</span><span class="p">))</span>
</span><span class="hll">    <span class="n">rsm</span><span class="p">(</span><span class="n">p_p11</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">p_spy</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span><span class="hll">  <span class="k">else</span><span class="p">:</span>
</span><span class="hll">    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">__super__</span>
</span><span class="hll">    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
</span><span class="hll">  <span class="k">return</span> <span class="n">status</span>
</span></pre></div>
</td></tr></table></div>
<p>Our goal is to take a statechart XML spec, pass it into an XmlChart, and have
the XmlChart build up the Regions objects, the Region objects and the injector state
functions.  The metaprogramming techniques used to build these kinds of functions are
described <a class="reference internal" href="techniques.html#techniques-adding-and-removing-behavior-from-functions"><span class="std std-ref">in this section</span></a>,
and the technique can be examined in isolation in the <code class="docutils literal notranslate"><span class="pre">example/augment.py</span></code>
file.</p>
<a class="reference external image-reference" href="_static/injector_metaprogramming.pdf"><img alt="_images/injector_metaprogramming.svg" class="noscale-center" src="_images/injector_metaprogramming.svg" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of the XmlChart will build the Regions and Region
objects, then based on this work and information gleaned from the XML spec it
will automatically write the injector state functions, linking different HSMs
together.</p>
<p>The injector construction happens in stages, we:</p>
<ol class="arabic simple">
<li><p>Get the HSM that the injector belongs to.</p></li>
<li><p>Call a function that sets the injector’s hierarchy and builds up the
injector’s boiler plate code, then returns a working augmentable function.</p></li>
<li><p>Customize the injector by having it drive events deeper into the HHSM:</p>
<ol class="arabic simple">
<li><p>Explicitly specify the signal_names that the deep parts of the chart need (suggest this behavior)</p></li>
<li><p>Iterate over the automatically generated final signals used by the deeper region objects, add injection code for these (suggest this behavior)</p></li>
</ol>
</li>
<li><p>Explicitly specify how this injector needs to react to the events that it isn’t
driving deeper into HHSM.  This involves linking a signal name to a
handler which describes a hook or a transition.  These handlers can be
whatever you want.</p></li>
<li><p>Explicitly specify how the injector should react to its regions-object’s final signal (where
it should transition).</p></li>
</ol>
<p>Here is some code which shows how this is done:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">XmlChart</span><span class="p">(</span><span class="n">InstrumentedActiveObject</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">log_config</span><span class="p">,</span> <span class="n">starting_state</span><span class="p">,</span> <span class="n">live_spy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">live_trace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># ...</span>
    <span class="c1"># build the p regions object</span>
    <span class="c1"># build the p regions object&#39;s region objects, provide names and initial</span>
    <span class="c1"># conditions</span>
    <span class="c1"># NOTE: the hidden state functions are automatically written in the add</span>
    <span class="c1"># method of the Region class</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Regions</span><span class="p">(</span>
      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p_p11&#39;</span><span class="p">,</span>
      <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">outer</span><span class="o">.</span><span class="n">lookup</span><span class="p">[</span><span class="s1">&#39;p_r1&#39;</span><span class="p">])</span>\
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r1&#39;</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r2&#39;</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="s1">&#39;p_p11_s21&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span><span class="o">.</span><span class="n">link</span><span class="p">()</span>
    <span class="c1"># ...</span>
    <span class="c1"># build the injector function for the p_p11 regions object</span>
    <span class="c1"># get the hsm the injector belongs to</span>
    <span class="n">hsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">hsm</span>
    <span class="c1"># call a function to set the injector&#39;s hierarchy and build up the</span>
    <span class="c1"># injector&#39;s boiler plate code, then return a working augmentable function</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">base_injector_template</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
      <span class="n">state_name</span><span class="o">=</span><span class="s1">&#39;p_p11&#39;</span><span class="p">,</span>
      <span class="n">super_state_name</span><span class="o">=</span><span class="s1">&#39;p_r1_over_hidden_region&#39;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Augment the injector.  Customize it by having it drive events deeper</span>
    <span class="c1"># into the HHSM</span>
    <span class="k">for</span> <span class="n">signal_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">,</span> <span class="s2">&quot;SRH3&quot;</span><span class="p">,</span> <span class="s2">&quot;PG2&quot;</span><span class="p">]:</span>
      <span class="n">signal</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">)</span>
      <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
        <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">=</span><span class="n">signal</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_inject_signal_to_inner_injector</span><span class="p">),</span>
        <span class="n">suggested_behavior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="p">)</span>

    <span class="c1"># pass the final signals into the inner parts of the chart, but only suggest</span>
    <span class="c1"># the behavior, so that if we need to over-write it, it will be</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">signal_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span>
      <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
        <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
        <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="n">signal_name</span><span class="p">),</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_inject_signal_to_inner_injector</span><span class="p">),</span>
        <span class="n">suggested_behavior</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="p">)</span>

    <span class="c1"># custom signals for this state</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;SEARCH_FOR_META_HOOKS&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_hook</span><span class="p">,</span> <span class="n">hooks</span><span class="o">=</span><span class="p">[</span><span class="n">signals</span><span class="o">.</span><span class="n">H1</span><span class="p">]),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;RC1&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;p_p12&quot;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;SRH2&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;RA1&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s2">&quot;p_p11&quot;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;PF1&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_hook</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;PC1&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s1">&#39;p_s21&#39;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="s1">&#39;RF1&#39;</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s1">&#39;p_p12_p11_s12&#39;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">p_p11</span> <span class="o">=</span> <span class="n">p_p11</span><span class="p">(</span>
      <span class="n">hsm</span><span class="o">=</span><span class="n">hsm</span><span class="p">,</span>
      <span class="n">signal</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">signals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">),</span>
      <span class="n">handler</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">template_meta_trans</span><span class="p">,</span> <span class="n">trans</span><span class="o">=</span><span class="s1">&#39;p_p12&#39;</span><span class="p">),</span>
      <span class="n">imposed_behavior</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>To see the base_injector_template, template_inject_signal_to_inner_injector,
template_meta_hook, template_meta_trans functions, reference
<code class="docutils literal notranslate"><span class="pre">xml_chart_5.2.py</span></code>.</p>
</div>
</div>
<div class="section" id="reflection-and-logging">
<span id="how-it-works-reflection-and-logging"></span><h2>Reflection and Logging<a class="headerlink" href="#reflection-and-logging" title="Permalink to this headline">#</a></h2>
<div class="section" id="souped-up-spy">
<span id="how-it-works-suped-up-spy"></span><h3>Souped Up Spy<a class="headerlink" href="#souped-up-spy" title="Permalink to this headline">#</a></h3>
<p>It would be almost impossible to tackle this problem without the spy
instrumentation.  To get the spy instrumentation working within the orthogonal
regions I wrote this wrapper and placed it above each region or state within a
region:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="k">def</span> <span class="nf">p_spy_on</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
   <span class="sd">&#39;&#39;&#39;spy wrapper for the parallel regions states</span>

<span class="sd">     **Args**:</span>
<span class="sd">        | ``fn`` (function): the state function</span>
<span class="sd">     **Returns**:</span>
<span class="sd">        (function): wrapped function</span>
<span class="sd">     **Example(s)**:</span>

<span class="sd">     .. code-block:: python</span>

<span class="sd">        @p_spy_on</span>
<span class="sd">        def example(p, e):</span>
<span class="sd">         status = return_status.UNHANDLED</span>
<span class="sd">         return status</span>
<span class="sd">   &#39;&#39;&#39;</span>
   <span class="nd">@wraps</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">_pspy_on</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">chart</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">spy_on</span><span class="p">(</span><span class="n">fn</span><span class="p">)(</span><span class="n">chart</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
       <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">rtc</span><span class="o">.</span><span class="n">spy</span><span class="p">):</span>
<span class="hll">         <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SEARCH_FOR_SUPER_SIGNAL&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
</span>         <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
           <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="s2">&quot;outmost&quot;</span><span class="p">):</span>
             <span class="n">chart</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
               <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
           <span class="k">else</span><span class="p">:</span>
             <span class="n">chart</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
               <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chart</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
       <span class="n">chart</span><span class="o">.</span><span class="n">rtc</span><span class="o">.</span><span class="n">spy</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
     <span class="k">else</span><span class="p">:</span>
       <span class="n">e</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">chart</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">status</span>
   <span class="k">return</span> <span class="n">_pspy_on</span>
</pre></div>
</td></tr></table></div>
<p>You can see on line 22 I have filtered out any spy line with the name
<code class="docutils literal notranslate"><span class="pre">SEARCH_FOR_SUPER</span></code>.  This was to reduce the amount of noise in the
instrumentation.</p>
<p>The spy itself is written to a log file and/or written to the terminal.</p>
</div>
<div class="section" id="souped-up-state-name-reflection">
<span id="how-it-works-suped-up-state-name-reflection"></span><h3>Souped Up State Name Reflection<a class="headerlink" href="#souped-up-state-name-reflection" title="Permalink to this headline">#</a></h3>
<p>If you use the vanilla <code class="docutils literal notranslate"><span class="pre">state_name</span></code> method provided within miros you will only
be able to see the outer most state holding the orthogonal regions; but it will
not reach into this collection of orthogonal regions and report on the active state
of each of them.</p>
<p>To see all of the active states at once use the <code class="docutils literal notranslate"><span class="pre">active_states</span></code> method of
the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> class.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">example</span> <span class="o">=</span> <span class="n">XmlChart</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span>
  <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;/mnt/c/github/miros-xml/experiment/parallel_example_4.log&quot;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">example</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="n">example</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">to_p</span><span class="p">))</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">active_states</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">active_states</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&gt;10}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;to_p&quot;</span><span class="p">,</span> <span class="n">active_states</span><span class="p">))</span>
<span class="hll"><span class="k">assert</span> <span class="n">active_states</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</span></pre></div>
</td></tr></table></div>
<p>In the above listing we see how the chart is created, started and how you can
send a <code class="docutils literal notranslate"><span class="pre">to_p</span></code> event into it, then we ask it for its active states.  We see it
reports <code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code>, which describes all of it’s
current states and some regional information by having nested lists.  The
outermost list represents the whole chart and the inner list represents that
<code class="docutils literal notranslate"><span class="pre">p_p11_s11</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_s21</span></code> are within a parallel region.</p>
<p>To code required to make <code class="docutils literal notranslate"><span class="pre">active_states</span></code> is within the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">active_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="n">parallel_state_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">recursive_get_states</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parallel_state_names</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_regions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">state_name</span> <span class="ow">in</span> <span class="n">parallel_state_names</span><span class="p">:</span>
          <span class="n">_states</span> <span class="o">=</span> <span class="n">recursive_get_states</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
          <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_states</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">states</span>

  <span class="n">states</span> <span class="o">=</span> <span class="n">recursive_get_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">states</span>
</pre></div>
</div>
</div>
<div class="section" id="simplifying-the-inner-injector-functions">
<span id="how-it-works-simplifying-the-inner-injector-functions"></span><h3>Simplifying the Inner Injector Functions<a class="headerlink" href="#simplifying-the-inner-injector-functions" title="Permalink to this headline">#</a></h3>
<p>The inner regions will need to access XmlChart methods and attributes to work.</p>
<p>The spy scribble method will be contained in the XmlChart object.  It will need
to be accessed by state functions used by the inner regions.  The <code class="docutils literal notranslate"><span class="pre">outmost</span></code>
attribute can be used to access any item of the XmlChart object from within an
inner Region object.</p>
<p>Here is an example of how to post to the fifo of the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region from
anywhere within the state chart.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">some_signal</span><span class="p">))</span>
</pre></div>
</div>
<p>The region accesses the outmost part of itself, the XmlChart object, then
accesses its regions dict with the ‘p_p11’ key, then post to that subregion’s
post_fifo queu, the drives that event through that orthogonal region before
returning control back to the program.  There is a lot going on, but it is very
noisy.</p>
<p>Consider how we would use a the spy scribble within an inner region:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
  <span class="n">region</span><span class="o">.</span><span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>
</pre></div>
</div>
<p>There are common functions that will be called over and over again within the
inner region’s injectors and to tighten up the code an
<code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code> function writer was made.  It looks like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
 <span class="k">def</span> <span class="nf">outmost_region_functions</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">region_name</span><span class="p">):</span>

   <span class="n">outmost</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">outmost</span>
   <span class="k">def</span> <span class="nf">scribble</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">string</span><span class="p">))</span>

   <span class="n">post_fifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">_post_fifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">post_lifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">_post_lifo</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">region_name</span><span class="p">]</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
   <span class="n">token_match</span> <span class="o">=</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span>
   <span class="k">return</span> <span class="n">post_fifo</span><span class="p">,</span> <span class="n">_post_fifo</span><span class="p">,</span> <span class="n">post_lifo</span><span class="p">,</span> <span class="n">_post_lifo</span><span class="p">,</span> <span class="n">token_match</span><span class="p">,</span> <span class="n">scribble</span>
</pre></div>
</td></tr></table></div>
<p>The functools partial method is used to prefill arguments to the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code>,
<code class="docutils literal notranslate"><span class="pre">_post_fifo</span></code>, <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code>, <code class="docutils literal notranslate"><span class="pre">_post_lifo</span></code> and <code class="docutils literal notranslate"><span class="pre">token_match</span></code> methods.  A
custom <code class="docutils literal notranslate"><span class="pre">scribble</span></code> function is written and returned as well.</p>
<p>On line 1 we see that the result is cached to speed up calls to the
<code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code>.</p>
<p>At the top of any injector you will see this <code class="docutils literal notranslate"><span class="pre">outmost_region_functions</span></code>,
function builder used like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="c1"># ..</span>
  <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
   <span class="n">_post_fifo</span><span class="p">,</span>
   <span class="n">post_lifo</span><span class="p">,</span>
   <span class="n">_post_lifo</span><span class="p">,</span>
   <span class="n">token_match</span><span class="p">,</span>
   <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p11&#39;</span><span class="p">)</span>

   <span class="c1"># inner region&#39;s state function code here</span>
</pre></div>
</div>
</div>
<div class="section" id="reading-the-log-file">
<span id="how-it-works-reading-the-log-file"></span><h3>Reading the Log File<a class="headerlink" href="#reading-the-log-file" title="Permalink to this headline">#</a></h3>
<p>The XmlChart contains the thread which drives the parallel processes.  It can
push events through each of the inner orthogonal components with calls to the
<code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code> method of each region.  However, this makes reading the
logs a bit confusing, since an orthogonal region’s actions appear to occur
before XmlChart event handling which drove those actions in the first place.
This should become a bit more clear with an example, consider the following log
snippet:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span> S: <span class="o">[</span>x<span class="o">]</span> to_p:outer_state
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p<span class="o">]</span> ENTRY_SIGNAL
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> enter_region:p_r1_under_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> ENTRY_SIGNAL:p_r1_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> INIT_SIGNAL:p_r1_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> ENTRY_SIGNAL:p_r1_over_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11<span class="o">]</span> ENTRY_SIGNAL
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> enter_region:p_p11_r1_under_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> ENTRY_SIGNAL:p_p11_r1_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> INIT_SIGNAL:p_p11_r1_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> ENTRY_SIGNAL:p_p11_r1_over_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> ENTRY_SIGNAL:p_p11_s11
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r1<span class="o">]</span> INIT_SIGNAL:p_p11_s11
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> enter_region:p_p11_r2_under_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> ENTRY_SIGNAL:p_p11_r2_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> INIT_SIGNAL:p_p11_r2_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> ENTRY_SIGNAL:p_p11_r2_over_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> ENTRY_SIGNAL:p_p11_s21
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_p11_r2<span class="o">]</span> INIT_SIGNAL:p_p11_s21
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> ENTRY_SIGNAL:p_p11
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r1<span class="o">]</span> INIT_SIGNAL:p_p11
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> enter_region:p_r2_under_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> ENTRY_SIGNAL:p_r2_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> INIT_SIGNAL:p_r2_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> ENTRY_SIGNAL:p_r2_over_hidden_region
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> ENTRY_SIGNAL:p_s21
 S: <span class="o">[</span>x<span class="o">]</span> <span class="o">[</span>p_r2<span class="o">]</span> INIT_SIGNAL:p_s21
<span class="hll"> S: <span class="o">[</span>x<span class="o">]</span> to_p:outer_state
</span><span class="hll"> S: <span class="o">[</span>x<span class="o">]</span> SEARCH_FOR_SUPER_SIGNAL:p
</span><span class="hll"> S: <span class="o">[</span>x<span class="o">]</span> ENTRY_SIGNAL:p
</span><span class="hll"> S: <span class="o">[</span>x<span class="o">]</span> INIT_SIGNAL:p
</span><span class="hll"> S: <span class="o">[</span>x<span class="o">]</span> &lt;- Queued:<span class="o">(</span><span class="m">0</span><span class="o">)</span> Deferred:<span class="o">(</span><span class="m">0</span><span class="o">)</span>
</span> R:
 <span class="o">[</span><span class="s1">&#39;outer_state&#39;</span><span class="o">]</span> &lt;- <span class="nv">to_p</span> <span class="o">==</span> <span class="o">[[</span><span class="s1">&#39;p_p11_s11&#39;</span>, <span class="s1">&#39;p_p11_s21&#39;</span><span class="o">]</span>, <span class="s1">&#39;p_s21&#39;</span><span class="o">]</span>
</pre></div>
</div>
<p>The highlighted code describes event handling of the XmlChart which drove the
actions seen above that part of the listing.  The output of the R: tells us how
this happened in the first place.  The system was in a <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> then it
received a <code class="docutils literal notranslate"><span class="pre">to_p</span></code> event, which caused it to enter a number of parallel states,
<code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code>.  To see how this happened, you would
read the logs before the highlighted section.</p>
<p>With enough effort I would make the log file linear in time, but it might not be
worth the effort.</p>
</div>
</div>
<div class="section" id="building-a-subregion">
<span id="how-it-works-building-a-subregion"></span><h2>Building a Subregion<a class="headerlink" href="#building-a-subregion" title="Permalink to this headline">#</a></h2>
<p>We will build <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> in the following diagram:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>To build the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> subregion you will need to:</p>
<ol class="arabic simple">
<li><p>Create an injector:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># any event handled within there regions must be pushed from here</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">)</span>
      <span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span>
    <span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p12</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p12</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">META_EXIT</span><span class="p">):</span>
    <span class="n">region1</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_region</span><span class="p">()</span>
    <span class="n">region2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get_region</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">region1</span> <span class="o">==</span> <span class="n">region2</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">EXIT_SIGNAL</span> <span class="ow">or</span>
       <span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">)))</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">r</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_r1_over_hidden_type</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
<p>2. Create the injectee states.  These are the under_hidden, region, and over_hidden state for
that subregion of the orthogonal component which behaves like a subregion:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_under_hidden_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;enter_region&quot;</span><span class="p">)):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_region</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">top</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="c1"># if _state is a child of this state then transition to it</span>
    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">_state</span><span class="p">):</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s11</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">region_exit</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_under_hidden_region</span><span class="p">)</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_META</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_under_hidden_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r1_over_hidden_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span><span class="o">==</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_r1_region</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_s11</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s12</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">rr</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">p_p11_r1_over_hidden_region</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">SUPER</span>
  <span class="k">return</span> <span class="n">status</span>

<span class="c1"># ..</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Ensure all signals which are passed into the region are injected by outer injectors:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for INIT_META</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
  <span class="c1"># any event handled within there regions must be pushed from here</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;F1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;G3&quot;</span><span class="p">)</span>
      <span class="p">):</span>
    <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p11&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
      <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Add the region to the XmlChart’s regions dict within the XmlChart
<code class="docutils literal notranslate"><span class="pre">__init__</span></code> method:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Regions</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p_p11&#39;</span><span class="p">,</span>
  <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>\
<span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r1&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span>\
<span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;p_p11_r2&#39;</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">)</span><span class="o">.</span><span class="n">link</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="writing-wtf-events-across-regions">
<span id="how-it-works-writing-wtf-events-across-regions"></span><h2>Writing WTF Events Across Regions<a class="headerlink" href="#writing-wtf-events-across-regions" title="Permalink to this headline">#</a></h2>
<p>This section will contain the how_it_works needed to construct the blue <code class="docutils literal notranslate"><span class="pre">WTF</span></code>
events, or events that span across parallel regions in this example program.
The <code class="docutils literal notranslate"><span class="pre">xml_chart_4</span></code> diagram shown below is based upon the <a class="reference external" href="https://aleph2c.github.io/miros/_static/comprehensive_no_instrumentation.pdf">hsm comprehensive
diagram in the miros project</a>.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">WTF</span></code> is a backronym and it stands for “Witness The Fitness” (lifted from
my friend Jen Farroll’s <a class="reference external" href="http://www.witnessthefitness.ca">personal training business</a>).</p>
</div>
<div class="section" id="e-wtf-events">
<span id="how-it-works-e-events"></span><h3>E WTF Events<a class="headerlink" href="#e-wtf-events" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E</span></code> events start at the edge of a parallel region, then go deeper into the
chart.  See <code class="docutils literal notranslate"><span class="pre">E0</span></code>, <code class="docutils literal notranslate"><span class="pre">E1</span></code> and <code class="docutils literal notranslate"><span class="pre">E2</span></code> in the diagram below.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>The <code class="docutils literal notranslate"><span class="pre">E</span></code> events in the orthogonal component mapping start at an injector, then
are dispatched to all regions managed by that injector.  The <code class="docutils literal notranslate"><span class="pre">E</span></code> event is
caught then turned into a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> which may contain 0 or more
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> events as payloads within it.  This is explained in detail in the
<code class="docutils literal notranslate"><span class="pre">E0</span></code> section.  The <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> is kind of like an onion event, each layer
corresponding to either an injector or injectee part of the design.</p>
</div>
<div class="section" id="e0-wtf-event">
<span id="how-it-works-e0-wtf-event"></span><h3>E0 WTF Event<a class="headerlink" href="#e0-wtf-event" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E0</span></code> event occurs from the outer most threaded state chart and it passes over
multiple regional boundaries.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>This WTF meta event is initially captured in the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
  <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E0&quot;</span><span class="p">)):</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter outer_state&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">payload_string</span><span class="p">(</span><span class="n">_e</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
  <span class="c1"># ...</span>
</pre></div>
</div>
<p>To build a state chart and send it an <code class="docutils literal notranslate"><span class="pre">E0</span></code> event, you would type the
following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">example</span> <span class="o">=</span> <span class="n">XmlChart</span><span class="p">(</span>
  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
  <span class="n">log_file</span><span class="o">=</span><span class="s2">&quot;/mnt/c/github/miros-xml/experiment/parallel_example_4.log&quot;</span><span class="p">,</span>
  <span class="n">live_trace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
  <span class="n">live_spy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">example</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="s2">&quot;E0&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>To see what happens we can view the log:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E0</span><span class="p">:</span><span class="n">outer_state</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E0</span><span class="p">:</span><span class="n">outer_state</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span class="hll"> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p</span> <span class="n">at</span> <span class="mh">0x7f5d25d526a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">    <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_r1_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d496a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">          <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">             <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">SEARCH_FOR_SUPER_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span>
 <span class="p">[</span><span class="s1">&#39;outer_state&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E0</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s22&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</div>
<hr class="docutils" />
<p><strong>Analysis:</strong></p>
<p>We see at the bottom of the log (highlighted) how the <code class="docutils literal notranslate"><span class="pre">E0</span></code> creates a
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event which contains other <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> events.</p>
<p>The key to understanding how the transitions occur is to track this
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event from the <code class="docutils literal notranslate"><span class="pre">outer_state</span></code> to the <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code> state.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">outer_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># ...</span>
   <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E0&quot;</span><span class="p">)):</span>
     <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter outer_state&quot;</span><span class="p">)</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:outer_state&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span>     <span class="bp">self</span><span class="o">.</span><span class="n">scribble</span><span class="p">(</span><span class="n">payload_string</span><span class="p">(</span><span class="n">_e</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
   <span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>On line 9 meta_init is used to create the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code>.  As of line 9:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">p</span>
<span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span>
   <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_r1_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d496a8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
         <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
            <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>On line 10 <code class="docutils literal notranslate"><span class="pre">_e</span></code>’s contents are injected into the log which we can see in the
previous listing.  On line 11, we place <code class="docutils literal notranslate"><span class="pre">_e.payload.event</span></code> into the fifo of
our XmlChart statechart.  On line 12 we transition to <code class="docutils literal notranslate"><span class="pre">_e.payload.state</span></code> (<code class="docutils literal notranslate"><span class="pre">p</span></code>).</p>
<p>Let’s look at the important part of the <code class="docutils literal notranslate"><span class="pre">p</span></code> state function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span>    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
 <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> function is the first injector.  We see on line 2 the word <code class="docutils literal notranslate"><span class="pre">self</span></code>,
which by convention, tells us we are in a thread connected statechart and not a
orthogonal-region’s HSM.</p>
<p>On line 9 we see that the next event and state are stripped off of the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> which is sitting in the FIFO queue of the XmlChart.  This is an
exotic way to program, very eccentric.  Normally you do not touch the queues,
you let the framework handle this information for you, we are breaking this
rule, and use the queue as a kind of programming callstack.</p>
<p>As of line 9:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_r1_region</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7f5d25d498c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
          <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">peel_meta</span></code> method looks like this:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">peel_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> \
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">META_INIT</span><span class="p">:</span>
<span class="hll">    <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">event</span><span class="p">,</span> <span class="n">_e</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table></div>
<p>If there is an event on the queue and it is an <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> then we pop it off
the stack.  We do this before the underlying miros framework has a chance to
handle it.  We parasitize the FIFO for our own purpose and the miros framework
is none the wiser for it.</p>
<p>Finally we return the event and the state information on line 7.</p>
<p>Next consider line 10-11 of the <code class="docutils literal notranslate"><span class="pre">p</span></code> listing:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
<span class="hll">    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
</span><span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span>    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
 <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>After <code class="docutils literal notranslate"><span class="pre">peel_meta</span></code> peels off the first onion layer of our <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event,
we place its inner contents into the <code class="docutils literal notranslate"><span class="pre">p</span></code> subregion’s FIFO using the <code class="docutils literal notranslate"><span class="pre">_post_fifo</span></code> method.</p>
<p>Any posting event with a <code class="docutils literal notranslate"><span class="pre">_</span></code> prepended to it, by convention does not drive the
event through its inner regions, it just posts items onto their queues:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_post_fifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code>. The <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> has
these state functions:</p>
<ul class="simple">
<li><p>p_r1_under_hidden_region</p></li>
<li><p>p_r1_region</p></li>
<li><p>p_r1_over_hidden_region</p></li>
<li><p>p_p11 (injector)</p></li>
<li><p>p_p12 (injector)</p></li>
<li><p>p_r1_final</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> has these state functions:</p>
<ul class="simple">
<li><p>p_r2_under_hidden_region</p></li>
<li><p>p_r2_region</p></li>
<li><p>p_r2_over_hidden_region</p></li>
<li><p>p_r2_final</p></li>
<li><p>p_s21</p></li>
<li><p>p_p22 (injector)</p></li>
</ul>
<p>Looking back to <code class="docutils literal notranslate"><span class="pre">p</span></code>, on line 13 we see how META_INIT is driven into the internal regions:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@spy_on</span>
<span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;[p] </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p&quot;</span><span class="p">)</span>
<span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">),</span> <span class="n">outmost</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>The <code class="docutils literal notranslate"><span class="pre">p</span></code> region’s queue has a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event in it, on line 13 we push the
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event ahead of it using the <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> event.  This causes
the <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event to both barge ahead of the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event in
both of the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> queues.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> event does two things, it posts using a lifo technique then
drives all events through the inner regions using the <code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code>
method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post_lifo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
  <span class="p">[</span><span class="n">region</span><span class="o">.</span><span class="n">complete_circuit</span><span class="p">()</span> <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regions</span><span class="p">]</span>
</pre></div>
</div>
<p>After the <code class="docutils literal notranslate"><span class="pre">post_lifo</span></code> call on line 13 of the p listing, there is an
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event and a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event on both the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_r2</span></code> orthogonal region queues.  To see what happens we need to look at our
abstract HSM strategy:</p>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="scale-to-fit" src="_images/hidden_dynamics2.svg" /></a>
<p>An <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> causes the transitions from <code class="docutils literal notranslate"><span class="pre">p_r1_under_hidden_region</span></code>
and <code class="docutils literal notranslate"><span class="pre">p_r2_under_hidden_region</span></code> to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>
respectively.  Then the <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> signal of the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> state functions are fired.  To see what happens next we look at
the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> injectee function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_r1_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
<span class="hll">  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
</span><span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span><span class="hll">    <span class="c1"># if _state is a child of this state then transition to it</span>
</span><span class="hll">    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_r1_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
</span><span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11</span><span class="p">)</span>
</span><span class="hll">    <span class="k">else</span><span class="p">:</span>
</span><span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
</span><span class="hll">      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span class="hll">        <span class="n">r</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll"> <span class="c1"># ...</span>
</span></pre></div>
</td></tr></table></div>
<p>On line 6 we see another layer is peeled off the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event.  If the
<code class="docutils literal notranslate"><span class="pre">_state</span></code> information isn’t present or the target state is not a child of the
<code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> state then we fall back to our default initialization; if line 8
returns true, the <code class="docutils literal notranslate"><span class="pre">_e</span></code> event is thrown in the garbage and the default behavior
of the initialization occurs.  For this region the default behavior to
transition to <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>.</p>
<p>But line 8 returns false in our situation because:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r2_region</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b1e0</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>So we transition to the value of <code class="docutils literal notranslate"><span class="pre">_state</span></code>, <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>, and we post <code class="docutils literal notranslate"><span class="pre">_e</span></code> into our fifo and
drive the event through to completion.  Looking back to our log trace we can see
that this <code class="docutils literal notranslate"><span class="pre">_state</span></code> variable would have been <code class="docutils literal notranslate"><span class="pre">p_p11</span></code>, which is the injector
for the next internal region.</p>
<p>So let’s look at that <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> injector.</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="hll"><span class="nd">@p_spy_on</span>
</span><span class="k">def</span> <span class="nf">p_p11</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  r is either p_r1, p_r2 region</span>
<span class="sd">  r.outer = p</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
  <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
   <span class="n">_post_fifo</span><span class="p">,</span>
   <span class="n">post_lifo</span><span class="p">,</span>
   <span class="n">_post_lifo</span><span class="p">,</span>
   <span class="n">token_match</span><span class="p">,</span>
   <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p11&#39;</span><span class="p">)</span>

  <span class="c1"># enter all regions</span>
  <span class="k">if</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">ENTRY_SIGNAL</span><span class="p">):</span>
    <span class="n">pprint</span><span class="p">(</span><span class="s2">&quot;enter p_p11&quot;</span><span class="p">)</span>
    <span class="n">scribble</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
    <span class="k">if</span> <span class="n">_state</span><span class="p">:</span>
      <span class="n">_post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">outmost</span><span class="o">=</span><span class="n">outmost</span><span class="p">)</span>
    <span class="n">post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">enter_region</span><span class="p">))</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
<span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>We see the same pattern we saw in the <code class="docutils literal notranslate"><span class="pre">p</span></code> injector.  If there is an
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event waiting in the queue, it is peeled.  If there is <code class="docutils literal notranslate"><span class="pre">_state</span></code>
information in the peeling, remaining part of the event is place into the fifo
of the <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region, then that region’s state handlers are sent an
<code class="docutils literal notranslate"><span class="pre">enter_region</span></code> event.</p>
<p>As of line 9 the following is true:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11_r2_region</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s22</span> <span class="n">at</span> <span class="mh">0x7f5d25d4b510</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">p_p11</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_p11_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_r2</span></code>.  The
<code class="docutils literal notranslate"><span class="pre">p_p11_r1</span></code> region has these state functions.</p>
<ul class="simple">
<li><p>p_p11_r1_under_hidden_region</p></li>
<li><p>p_p11_r1_region</p></li>
<li><p>p_p11_r1_over_hidden_region</p></li>
<li><p>p_p11_r1_final</p></li>
<li><p>p_p11_s11</p></li>
<li><p>p_p11_s12</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">p_p11_r2</span></code> region has these state functions.</p>
<ul class="simple">
<li><p>p_p11_r2_under_hidden_region</p></li>
<li><p>p_p11_r2_region</p></li>
<li><p>p_p11_r2_over_hidden_region</p></li>
<li><p>p_p11_r2_final</p></li>
<li><p>p_p11_s21</p></li>
<li><p>p_p11_s22</p></li>
</ul>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="scale-to-fit" src="_images/hidden_dynamics2.svg" /></a>
<p>The same injectee pattern is seen again.  The <code class="docutils literal notranslate"><span class="pre">enter_region</span></code> causes the
transitions from <code class="docutils literal notranslate"><span class="pre">p_p11_r1_under_hidden_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_p11_r1_under_hidden_region</span></code> to <code class="docutils literal notranslate"><span class="pre">p_p11_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code>
respectively.  Then the <code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> clause of <code class="docutils literal notranslate"><span class="pre">p_p11_r1_region</span></code> and
<code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code> functions are activated.  To see what happens next we look
at the <code class="docutils literal notranslate"><span class="pre">p_p11_r2_region</span></code> injectee function:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nd">@p_spy_on</span>
<span class="k">def</span> <span class="nf">p_p11_r2_region</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
  <span class="c1"># ...</span>
  <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
<span class="hll">    <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
</span>    <span class="c1"># if _state is a child of this state then transition to it</span>
<span class="hll">    <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rr</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_p11_r2_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
</span>      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_p11_s21</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
<span class="hll">      <span class="n">status</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
</span>      <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rr</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
<span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>As of line 6 the following is true:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11_s22</span>
<span class="n">_e</span>  <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>On line 6 the last layer of the onion is pulled.  The <code class="docutils literal notranslate"><span class="pre">_state</span></code> variable
contains <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code> and the <code class="docutils literal notranslate"><span class="pre">_e</span></code> is set to None.  The logic to line 8 does
not apply to <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code>, so we call the <code class="docutils literal notranslate"><span class="pre">trans</span></code> method on line 11.</p>
</div>
<div class="section" id="e1-wtf-event">
<span id="how-it-works-e1-wtf-event"></span><h3>E1 WTF Event<a class="headerlink" href="#e1-wtf-event" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E1</span></code> event is very much like the <code class="docutils literal notranslate"><span class="pre">E0</span></code> event in that it uses a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event to
pass over multiple boundaries.  It difference from the <code class="docutils literal notranslate"><span class="pre">E0</span></code> event in that the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> needs to be sent the injector managing an inner orthogonal
component.  This injector is still part of the outer containing statechart.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>If we start the chart in <code class="docutils literal notranslate"><span class="pre">[['p_p11_s11',</span> <span class="pre">'p_p11_s22'],</span> <span class="pre">'p_s21']</span></code> the post an
<code class="docutils literal notranslate"><span class="pre">E1</span></code> event we will see the following logs:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">E1</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">POST_FIFO</span><span class="p">:</span><span class="n">META_INIT</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">force_region_init</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E1</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
</span><span class="hll"> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7fb8b27c88c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">    <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll">       <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E1</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span>
 <span class="p">[[</span><span class="s1">&#39;p_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s22&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E1</span> <span class="o">==</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</td></tr></table></div>
<p>The workings of the outer statechart are highlighted.  Despite, <code class="docutils literal notranslate"><span class="pre">E1</span></code> being
handled within the <code class="docutils literal notranslate"><span class="pre">p</span></code> region, the code needed to manage it is written in the <code class="docutils literal notranslate"><span class="pre">p</span></code> function which has access the <code class="docutils literal notranslate"><span class="pre">XmlChart</span></code> via the <code class="docutils literal notranslate"><span class="pre">self</span></code> keyword:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
 <span class="c1"># ..</span>
   <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E1&quot;</span><span class="p">)):</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p11_s22</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">))</span>
</span><span class="hll">     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span><span class="hll">     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</span></pre></div>
</td></tr></table></div>
<p>On line 8 the meta event is constructed, with a target equal to <code class="docutils literal notranslate"><span class="pre">p_p11_s22</span></code>
and it’s sources state set to <code class="docutils literal notranslate"><span class="pre">p</span></code>.  The event name is passed through into the
method, though it is currently not used.</p>
<p>Line 9, pushes a <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> into the <code class="docutils literal notranslate"><span class="pre">p</span></code> region’s orthogonal
component’s queue, then on line 10, the meta event is placed and the events are
driven through the orthogonal component by the <code class="docutils literal notranslate"><span class="pre">complete_circuit</span></code> method
within the <code class="docutils literal notranslate"><span class="pre">post_fifo</span></code> call.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event will be on the queue before the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code>
event.  The <code class="docutils literal notranslate"><span class="pre">p</span></code> region has two sub-regions, <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2</span></code>. The <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> has
these state functions:</p>
<ul class="simple">
<li><p>p_r1_under_hidden_region</p></li>
<li><p>p_r1_region</p></li>
<li><p>p_r1_over_hidden_region</p></li>
<li><p>p_p11 (injector)</p></li>
<li><p>p_p12 (injector)</p></li>
<li><p>p_r1_final</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> has these state functions:</p>
<ul class="simple">
<li><p>p_r2_under_hidden_region</p></li>
<li><p>p_r2_region</p></li>
<li><p>p_r2_over_hidden_region</p></li>
<li><p>p_r2_final</p></li>
<li><p>p_s21</p></li>
<li><p>p_p22 (injector)</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> will cause the <code class="docutils literal notranslate"><span class="pre">p_r1</span></code> orthogonal component to
transition to <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and the <code class="docutils literal notranslate"><span class="pre">p_r2</span></code> orthogonal component to
transition to <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>.  It does this so that the next event, the
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> waiting in the next spot of the queue will be seen by the
<code class="docutils literal notranslate"><span class="pre">INIT_SIGNAL</span></code> clause of the <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> functions:</p>
<a class="reference external image-reference" href="_static/hidden_dynamics2.pdf"><img alt="_images/hidden_dynamics2.svg" class="scale-to-fit" src="_images/hidden_dynamics2.svg" /></a>
<p>Both <code class="docutils literal notranslate"><span class="pre">p_r1_region</span></code> and <code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code> will now be presented with this
<code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11</span> <span class="n">at</span> <span class="mh">0x7fb8b27c88c8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
   <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>To see how to successfully trace the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event to its target read the <a class="reference internal" href="#how-it-works-e0-wtf-event"><span class="std std-ref">E0
recipe</span></a>.  In this case we will examine how the
<code class="docutils literal notranslate"><span class="pre">p_r2_region</span></code>, which is not a target of the <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> ditches the event
and behaves in accordance to its default INIT_SIGNAL behavior:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_r2_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="c1"># ...</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal</span> <span class="o">==</span> <span class="n">signals</span><span class="o">.</span><span class="n">INIT_SIGNAL</span><span class="p">):</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
     <span class="p">(</span><span class="n">_e</span><span class="p">,</span> <span class="n">_state</span><span class="p">)</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">peel_meta</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="c1"># search for META_INIT</span>
     <span class="k">if</span> <span class="n">_state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">has_a_child</span><span class="p">(</span><span class="n">p_r2_region</span><span class="p">,</span> <span class="n">_state</span><span class="p">):</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">p_s21</span><span class="p">)</span>
     <span class="k">else</span><span class="p">:</span>
       <span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">trans</span><span class="p">(</span><span class="n">_state</span><span class="p">)</span>
       <span class="c1">#print(&quot;p_r2_region init {}&quot;.format(_state))</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">_e</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="n">r</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
    <span class="c1"># ...</span>
</pre></div>
</td></tr></table></div>
<p>On line 7:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_state</span> <span class="o">=</span> <span class="n">p_p11</span>
<span class="n">_e</span> <span class="o">=</span> <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_r1_region</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8ae8</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
      <span class="n">META_INIT</span> <span class="o">&lt;</span><span class="n">function</span> <span class="n">p_p11_s12</span> <span class="n">at</span> <span class="mh">0x7fb8b27c8e18</span><span class="o">&gt;</span> <span class="o">-&gt;</span>
</pre></div>
</div>
<p>This will cause the <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">r.has_a_child(p_r2_region,</span> <span class="pre">_state)</span></code> to return True,
causing a transition to the <code class="docutils literal notranslate"><span class="pre">p_s21</span></code> state.</p>
</div>
<div class="section" id="e2-wtf-event">
<h3>E2 WTF Event<a class="headerlink" href="#e2-wtf-event" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">E2</span></code> event is like the <code class="docutils literal notranslate"><span class="pre">E1</span></code> event in that it uses a <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> event
to pass over multiple orthogonal component boundaries.  It differs from the
<code class="docutils literal notranslate"><span class="pre">E1</span></code> event in that its <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> needs to be sent from within an orthogonal
component and not from outer containing statechart.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">690</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">E2</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">693</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_over_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">694</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">695</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r1_under_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">696</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">697</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_over_hidden_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">697</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_region</span>
 <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">698</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p_r2_under_hidden_region</span>
<span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">699</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">699</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">E2</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">700</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">28</span> <span class="mi">13</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">39</span><span class="p">,</span><span class="mi">885</span> <span class="n">DEBUG</span><span class="p">:</span><span class="n">R</span><span class="p">:</span>
 <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">E2</span> <span class="o">==</span> \
 <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>To make this work, the <code class="docutils literal notranslate"><span class="pre">E2</span></code> must first be injected and driven through the
internal orthogonal components by the outer most injector (<code class="docutils literal notranslate"><span class="pre">p</span></code>):</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@spy_on</span>
 <span class="k">def</span> <span class="nf">p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="c1"># ..</span>

   <span class="c1"># any event handled within there regions must be pushed from here</span>
   <span class="k">elif</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e3&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e5&quot;</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">)</span> <span class="ow">or</span>
<span class="hll">       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">)</span> <span class="ow">or</span>
</span>       <span class="c1"># self.token_match(e.signal_name, &quot;G3&quot;) or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p11&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p12&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span> <span class="ow">or</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">final_signal_name</span><span class="p">)</span>
       <span class="p">)):</span>
     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>The construction of its META_INIT event occurs within the <code class="docutils literal notranslate"><span class="pre">p_p12</span></code> handler:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_p12</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
   <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
    <span class="n">_post_fifo</span><span class="p">,</span>
    <span class="n">post_lifo</span><span class="p">,</span>
    <span class="n">_post_lifo</span><span class="p">,</span>
    <span class="n">token_match</span><span class="p">,</span>
    <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p12&#39;</span><span class="p">)</span>
   <span class="c1"># ..</span>
   <span class="k">elif</span> <span class="n">outmost</span><span class="o">.</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">):</span>
     <span class="n">scribble</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
<span class="hll">     <span class="n">_e</span> <span class="o">=</span> <span class="n">outmost</span><span class="o">.</span><span class="n">meta_init</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">p_p12_p11_s12</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">p_p12</span><span class="p">,</span> <span class="n">sig</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">)</span>
</span><span class="hll">     <span class="c1"># this force_region_init might be a problem</span>
</span><span class="hll">     <span class="n">_post_lifo</span><span class="p">(</span><span class="n">Event</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="n">signals</span><span class="o">.</span><span class="n">force_region_init</span><span class="p">))</span>
</span><span class="hll">     <span class="n">post_fifo</span><span class="p">(</span><span class="n">_e</span><span class="p">)</span>
</span>     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
   <span class="c1"># ..</span>
</pre></div>
</td></tr></table></div>
<p>On line 14 we create a META_INIT as a reaction to the  <code class="docutils literal notranslate"><span class="pre">E2</span></code> event.  To build
such an <code class="docutils literal notranslate"><span class="pre">META_INIT</span></code> we need to specify the target, <code class="docutils literal notranslate"><span class="pre">t</span></code>, the source <code class="docutils literal notranslate"><span class="pre">s</span></code> and
the event’s signals name (E2).  The resulting meta event is returned as <code class="docutils literal notranslate"><span class="pre">_e</span></code>.</p>
<p>On line 10 the first location of each queue of the orthogonal regions of
<code class="docutils literal notranslate"><span class="pre">p_p12</span></code> have the <code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event posted to their far left location.  On
line 11, the <code class="docutils literal notranslate"><span class="pre">_e</span></code> meta event is placed the right of each
<code class="docutils literal notranslate"><span class="pre">force_region_init</span></code> event for each queue in the <code class="docutils literal notranslate"><span class="pre">p_p12</span></code> region, then all
events are pushed through those machines.</p>
<p>To make the <code class="docutils literal notranslate"><span class="pre">E2</span></code> event work for the entire chart, a handler needs to be added
to <code class="docutils literal notranslate"><span class="pre">p_p22</span></code>:</p>
<div class="highlight-python notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="nd">@p_spy_on</span>
 <span class="k">def</span> <span class="nf">p_p22</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
   <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">UNHANDLED</span>
   <span class="n">outmost</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">outmost</span>
   <span class="p">(</span><span class="n">post_fifo</span><span class="p">,</span>
    <span class="n">_post_fifo</span><span class="p">,</span>
    <span class="n">post_lifo</span><span class="p">,</span>
    <span class="n">_post_lifo</span><span class="p">,</span>
    <span class="n">token_match</span><span class="p">,</span>
<span class="hll">    <span class="n">scribble</span><span class="p">)</span> <span class="o">=</span> <span class="n">outmost_region_functions</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;p_p22&#39;</span><span class="p">)</span>
</span>   <span class="c1"># ..</span>
   <span class="c1"># any event handled within there regions must be pushed from here</span>
   <span class="k">elif</span><span class="p">(</span><span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;e4&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">token_match</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">,</span> <span class="s2">&quot;E2&quot;</span><span class="p">)</span>
       <span class="p">):</span>
     <span class="k">if</span> <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy</span> <span class="ow">and</span> <span class="n">outmost</span><span class="o">.</span><span class="n">instrumented</span><span class="p">:</span>
       <span class="n">outmost</span><span class="o">.</span><span class="n">live_spy_callback</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:p_p22&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">signal_name</span><span class="p">))</span>
     <span class="n">outmost</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="s1">&#39;p_p22&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">post_fifo</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
     <span class="n">status</span> <span class="o">=</span> <span class="n">return_status</span><span class="o">.</span><span class="n">HANDLED</span>
</pre></div>
</td></tr></table></div>
<p>If <code class="docutils literal notranslate"><span class="pre">E2</span></code> is not permitted to be driven through the <code class="docutils literal notranslate"><span class="pre">p_p22</span></code> the statechart
doesn’t work properly.</p>
</div>
<div class="section" id="c-wtf-events">
<span id="how-it-works-c-events"></span><h3>C WTF Events<a class="headerlink" href="#c-wtf-events" title="Permalink to this headline">#</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">C</span></code> events cause a transition from one orthogonal region to another.  The do
not span boundaries:</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
</div>
<div class="section" id="c0-wtf-event">
<span id="how-it-works-c0-wtf-event"></span><h3>C0 WTF Event<a class="headerlink" href="#c0-wtf-event" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">C0</span></code> event occurs within one or more orthogonal regions.   The basic
pattern involves the outer states letting the <code class="docutils literal notranslate"><span class="pre">C0</span></code> enter into its required
depth, then a region’s injector captures the event and uses the miros <code class="docutils literal notranslate"><span class="pre">trans</span></code> call
to cause the transition.  It does not require META events to manage its
transition across boundaries and is thereby the simplest <code class="docutils literal notranslate"><span class="pre">WTF</span></code> event.</p>
<a class="reference external image-reference" href="_static/xml_chart_4.pdf"><img alt="_images/xml_chart_4.svg" class="scale-to-fit" src="_images/xml_chart_4.svg" /></a>
<p>Suppose the chart was in a <code class="docutils literal notranslate"><span class="pre">[['p_p11_s12',</span> <span class="pre">'p_p11_s21'],</span> <span class="pre">'p_s21']</span></code> combination
of states and a <code class="docutils literal notranslate"><span class="pre">C0</span></code> was sent to the chart.  The log file would look like
this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="n">C0</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">region_exit</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_p11_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_p11_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_p11_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_p11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p12_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p12_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p12</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">EXIT_SIGNAL</span><span class="p">:</span><span class="n">p_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p22_r1_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r1_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r1</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s11</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">enter_region</span><span class="p">:</span><span class="n">p_p22_r2_under_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_r2_over_hidden_region</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_p22_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22_s21</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">ENTRY_SIGNAL</span><span class="p">:</span><span class="n">p_p22</span>
 <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="p">[</span><span class="n">p_r2</span><span class="p">]</span> <span class="n">INIT_SIGNAL</span><span class="p">:</span><span class="n">p_p22</span>
<span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="n">C0</span><span class="p">:</span><span class="n">p</span><span class="p">:</span><span class="n">HOOK</span>
</span><span class="hll"> <span class="n">S</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">Queued</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span> <span class="n">Deferred</span><span class="p">:(</span><span class="mi">0</span><span class="p">)</span>
</span> <span class="n">R</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;p_p11_s12&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_s21&#39;</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="n">C0</span> <span class="o">==</span> \
 <span class="p">[[[</span><span class="s1">&#39;p_p12_p11_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p12_p11_s21&#39;</span><span class="p">],</span> <span class="s1">&#39;p_p12_s21&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;p_p22_s11&#39;</span><span class="p">,</span> <span class="s1">&#39;p_p22_s21&#39;</span><span class="p">]]</span>
</pre></div>
</div>
<p>The highlighted parts of the log cause the upper part of the log to take place.</p>
</div>
</div>
<div class="section" id="hidden-dynamics">
<span id="how-it-works-hidden-dynamics"></span><h2>Hidden Dynamics<a class="headerlink" href="#hidden-dynamics" title="Permalink to this headline">#</a></h2>
</div>
</div>


        
        <div class="main-content__right-sidebar">
          <h2 class="sidebar-heading">On this page:</h2>
        </div>
      </div>
    </main>

    <div class="footer-wrapper">
      
      <footer class="main-footer main-footer--sidebar">
      
        <div class="relational-links">
          <div>
            
            ← <a class="relational-link" href="techniques.html" title="previous chapter">Techniques</a>
            
          </div>
          <div>
            
          </div>
        </div>
        
        <div class="copyright">
          © Copyright <span class="js-year"></span>,
          
          <a href="https://github.com/aleph2c" class="copyright_link">Scott Volk</a>.
          
        </div>
        
        
        <div class="last-updated">
          <span class="prefix">Last updated:</span>
          <span class="time">Jan 30, 2021 6:26 PM</span>
        </div>
        
        
        <div class="created-with">
          Created using <a href="http://sphinx-doc.org/" class="copyright_link">Sphinx</a> 3.4.0 with <span class="theme">13ds_theme_one</span>.
        </div>
        
      </footer>
    </div>
  </body>
</html>